metadata:
  name: <default name of the function>
  description: <description of the operatuon>
  labels: # key-value pairs to classify the function
    - "license:apache-2.0"
    - "domain:nlp"
    - "application:healthcare"
    - "platform:0.14"
    - "aspect:quality"
    - "type:job"
    - "phase:data-validation"
    - "framework:evidently"
kind: python #<runtime kind, as of platform>
spec: # full spec of the function as exported from the platform, es
  requirements:
    - accelerate==1.1.1
    - evaluate
    - datasets==3.1.0
    - torch==2.5.1
    - torch_tensorrt==2.5.0
    - torchmetrics==1.6.0
    - torchtext==0.18.0
    - transformer_engine==1.12.0
    - transformer_engine_cu12==1.12.0
    - transformers==4.46.3
    - pandas==2.2.3
    - numpy==2.1.3
    - numpyencoder==0.3.0
    - scikit-learn==1.5.2
    - scipy==1.14.1
    - GitPython==3.1.43
    - attrs==24.2.0
    - async-timeout==5.0.1
    - aiosignal==1.3.1
    - aiohappyeyeballs==2.4.4
    - aiohttp==3.11.9
    - Unidecode==1.3.8
  python_version: PYTHON3_10
  source:
    source: train.py
    handler: train
    base64: aW1wb3J0IHBhbmRhcyBhcyBwZAppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IGpzb24KaW1wb3J0IHRvcmNoCmZyb20gbnVtcHllbmNvZGVyIGltcG9ydCBOdW1weUVuY29kZXIKZnJvbSBza2xlYXJuLm1vZGVsX3NlbGVjdGlvbiBpbXBvcnQgU3RyYXRpZmllZFNodWZmbGVTcGxpdApmcm9tIGRhdGFzZXRzIGltcG9ydCBEYXRhc2V0LCBEYXRhc2V0RGljdApmcm9tIG9zIGltcG9ydCBwYXRoLCBtYWtlZGlycywgbGlzdGRpcgoKY2xhc3MgRGF0YWxvYWRlcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBmaWxlX3BhdGgsIGZpbGVfdHlwZT1Ob25lLCBsYWJlbF9jb2x1bW49J2xhYmVsJywgdGVzdF9zaXplPTAuMiwgdmFsX3NpemU9MC4yNSwgcmFuZG9tX3N0YXRlPTI1LCAqKmt3YXJncyk6CiAgICAgICAgIiIiCiAgICAgICAgSW5pdGlhbGl6ZSB0aGUgRGF0YWxvYWRlciBvYmplY3QgZm9yIHRyYWluaW5nIEN1c3RvbUJlcnRGb3JTZXF1ZW5jZUNsYXNzaWZpY2F0aW9uCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZmlsZV9wYXRoIChzdHIpOiBQYXRoIHRvIHRoZSBwYXJxdWV0IGZpbGUuCiAgICAgICAgICAgIGxhYmVsX2NvbHVtbiAoc3RyKTogVGhlIGNvbHVtbiBuYW1lIHJlcHJlc2VudGluZyBsYWJlbHMgaW4gdGhlIGRhdGFzZXQuCiAgICAgICAgICAgIHRlc3Rfc2l6ZSAoZmxvYXQpOiBQcm9wb3J0aW9uIG9mIHRoZSBkYXRhc2V0IHRvIHVzZSBhcyB0aGUgdGVzdCBzZXQuCiAgICAgICAgICAgIHZhbF9zaXplIChmbG9hdCk6IFByb3BvcnRpb24gb2YgdGhlIHRyYWluL3ZhbGlkYXRpb24gc3BsaXQgdG8gdXNlIGFzIHRoZSB2YWxpZGF0aW9uIHNldC4KICAgICAgICAgICAgcmFuZG9tX3N0YXRlIChpbnQpOiBTZWVkIGZvciByZXByb2R1Y2liaWxpdHkuCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5maWxlX3BhdGggPSBmaWxlX3BhdGgKICAgICAgICBzZWxmLmZpbGVfdHlwZSA9IGZpbGVfcGF0aC5zcGxpdCgnLicpWy0xXQogICAgICAgIHNlbGYubGFiZWxfY29sdW1uID0gbGFiZWxfY29sdW1uCiAgICAgICAgc2VsZi50ZXN0X3NpemUgPSB0ZXN0X3NpemUKICAgICAgICBzZWxmLnZhbF9zaXplID0gdmFsX3NpemUKICAgICAgICBzZWxmLnJhbmRvbV9zdGF0ZSA9IHJhbmRvbV9zdGF0ZQogICAgICAgIHNlbGYua3dhcmdzID0ga3dhcmdzCiAgICAgICAgc2VsZi5kZiA9IE5vbmUKICAgICAgICBzZWxmLmRhdGFzZXQgPSBOb25lCiAgICAgICAgc2VsZi5udW1fbGFiZWxzID0gTm9uZQogICAgICAgIHNlbGYuY2xhc3Nfd2VpZ2h0cyA9IE5vbmUKICAgICAgICBzZWxmLmVuY29kaW5nLCBzZWxmLnJldmVyc2VfZW5jb2RpbmcgPSBOb25lLCBOb25lCgogICAgZGVmIGxvYWRfZGF0YShzZWxmKToKICAgICAgICAgICAgIiIiTG9hZHMgdGhlIGZpbGUgYW5kIHByZXBhcmVzIHRoZSBkYXRhc2V0LiIiIgogICAgICAgICAgICBsb2FkZXJzID0gewogICAgICAgICAgICAgICAgJ2Nzdic6IHBkLnJlYWRfY3N2LAogICAgICAgICAgICAgICAgJ2d6aXAnOiBwZC5yZWFkX3BhcnF1ZXQsCiAgICAgICAgICAgICAgICAnZXhjZWwnOiBwZC5yZWFkX2V4Y2VsLAogICAgICAgICAgICAgICAgJ2pzb24nOiBwZC5yZWFkX2pzb24sCiAgICAgICAgICAgICAgICAnZmVhdGhlcic6IHBkLnJlYWRfZmVhdGhlciwKICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIGlmIHNlbGYuZmlsZV90eXBlIG5vdCBpbiBsb2FkZXJzOgogICAgICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIlVuc3VwcG9ydGVkIGZpbGUgdHlwZToge3NlbGYuZmlsZV90eXBlfSIpCiAgICAgICAgICAgIHNlbGYuZGYgPSBsb2FkZXJzW3NlbGYuZmlsZV90eXBlXShzZWxmLmZpbGVfcGF0aCwgKipzZWxmLmt3YXJncykucmVzZXRfaW5kZXgoKQogICAgCiAgICAgICAgICAgICMgTGFiZWxzIHNob3VsZCBzdGFydCBmcm9tIDA7IHRoZXkgd2lsbCBiZSBtYXBwZWQgYmFjawogICAgICAgICAgICAjIHdoZW4gc2F2aW5nIHRoZSBwcmVkaWN0ZWQgcmVzdWx0cwogICAgICAgICAgICBpZiBzZWxmLmRmW3NlbGYubGFiZWxfY29sdW1uXS5taW4oKSA9PSAxOgogICAgICAgICAgICAgICAgc2VsZi5kZltzZWxmLmxhYmVsX2NvbHVtbl0gLT0gMQogICAgCiAgICAgICAgICAgICMgTWFwIGxhYmVscyB0byBkZW5zZSBmb3IgQ3Jvc3NFbnRyb3B5TCAodGhlIGl0YWxpYW4gQkVSVCBkb2Vzbid0IGxpa2Ugc3BhcnNlIGFycmF5cykKICAgICAgICAgICAgdW5pcXVlX2xhYmVscywgbGFiZWxfY291bnRzID0gbnAudW5pcXVlKHNlbGYuZGZbc2VsZi5sYWJlbF9jb2x1bW5dLCByZXR1cm5fY291bnRzPVRydWUpCiAgICAgICAgICAgIHNlbGYubnVtX2xhYmVscyA9IGxlbih1bmlxdWVfbGFiZWxzKQogICAgICAgICAgICBzZWxmLmVuY29kaW5nID0ge2xhYmVsOmlkeCBmb3IgaWR4LGxhYmVsIGluIGVudW1lcmF0ZSh1bmlxdWVfbGFiZWxzKX0KICAgICAgICAgICAgc2VsZi5yZXZlcnNlX2VuY29kaW5nID0ge2lkeDpsYWJlbCBmb3IgaWR4LGxhYmVsIGluIGVudW1lcmF0ZSh1bmlxdWVfbGFiZWxzKX0KICAgICAgICAgICAgc2VsZi5kZltzZWxmLmxhYmVsX2NvbHVtbl0gPSBzZWxmLmRmW3NlbGYubGFiZWxfY29sdW1uXS5tYXAoc2VsZi5lbmNvZGluZykKICAgICAgICAgICAgIyBzYXZpbmcgdGhlIHJldmVyc2UgaW5kZXhpbmcKICAgICAgICAgICAgd2l0aCBvcGVuKCJyZXZlcnNlX2VuY29kaW5nLmpzb24iLCAidyIpIGFzIGY6CiAgICAgICAgICAgICAgICBqc29uLmR1bXAoc2VsZi5yZXZlcnNlX2VuY29kaW5nLCBmLAogICAgICAgICAgICAgICAgICAgICAgICAgIGluZGVudD00LCBzb3J0X2tleXM9VHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICBzZXBhcmF0b3JzPSgnLCAnLCAnOiAnKSwgZW5zdXJlX2FzY2lpPUZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNscz1OdW1weUVuY29kZXIpCiAgICAKICAgICAgICAgICAgIyBDbGFzcyB3ZWlnaHRzCiAgICAgICAgICAgIGludmVyc2UgPSAxIC8gbGFiZWxfY291bnRzCiAgICAgICAgICAgIG5vcm1hbGl6ZWRfd2VpZ2h0cyA9IGludmVyc2UgLyBpbnZlcnNlLnN1bSgpCiAgICAgICAgICAgIHByaW50KHNlbGYuZGYuaGVhZCgpKQogICAgICAgICAgICAjIHNlbGYuY2xhc3Nfd2VpZ2h0cyA9IHRvcmNoLkZsb2F0VGVuc29yKG5vcm1hbGl6ZWRfd2VpZ2h0cykudG8oJ2N1ZGEnKQoKCiAgICBkZWYgc3RyYXRpZmllZF9zcGxpdChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBQZXJmb3JtcyBzdHJhdGlmaWVkIHRyYWluL3ZhbGlkYXRpb24vdGVzdCBzcGxpdC4KICAgICAgICBHaXZlbiB0aGF0IHRoZSBkYXRhIGhhcyBtYW55IGxhYmVscyBhbmQgdGhleSBhcmUgb2Z0ZW4gdW5lcXVhbGx5IGRpc3RyaWJ1dGVkLAogICAgICAgIG1hbnkgY2xhc3NlcyBjYW4gYmUgbm90IHJlcHJlc2VudGVkIGF0IGFsbCBpbiB0aGUgdHJhaW5pbmcgc2Vzc2lvbi4KICAgICAgICBUaGlzIG1ldGhvZCBmb3JjZXMgc2ltaWxhciBjbGFzcyBkaXN0cmlidXRpb25zLgogICAgICAgIElmIHNvbWUgY2xhc3NlcyBhcmUgaW4gbGVzcyB0aGFuIDMgb2JzZXJ2YXRpb25zLCBpdCB3aWxsIHJhaXNlIGFuIGVycm9yLgogICAgICAgICIiIgogICAgICAgIGlmIHNlbGYuZGYgaXMgTm9uZToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiRGF0YSBub3QgbG9hZGVkLiBDYWxsIGxvYWRfZGF0YSgpIGZpcnN0LiIpCgogICAgICAgICMgRmlyc3Qgc3BsaXQ6IHRyYWluK3ZhbC90ZXN0CiAgICAgICAgc3BsaXQgPSBTdHJhdGlmaWVkU2h1ZmZsZVNwbGl0KG5fc3BsaXRzPTEsIHRlc3Rfc2l6ZT1zZWxmLnRlc3Rfc2l6ZSwgcmFuZG9tX3N0YXRlPXNlbGYucmFuZG9tX3N0YXRlKQogICAgICAgIHRyYWluX3ZhbF9pZHgsIHRlc3RfaWR4ID0gbmV4dChzcGxpdC5zcGxpdChzZWxmLmRmLCBzZWxmLmRmW3NlbGYubGFiZWxfY29sdW1uXSkpCiAgICAgICAgdHJhaW5fdmFsX2RhdGEgPSBzZWxmLmRmLmlsb2NbdHJhaW5fdmFsX2lkeF0ucmVzZXRfaW5kZXgoZHJvcD1UcnVlKQogICAgICAgIHRlc3Rfc2V0ID0gc2VsZi5kZi5pbG9jW3Rlc3RfaWR4XS5yZXNldF9pbmRleChkcm9wPVRydWUpCgogICAgICAgICMgU2Vjb25kIHNwbGl0OiB0cmFpbi92YWxpZGF0aW9uCiAgICAgICAgc3BsaXQgPSBTdHJhdGlmaWVkU2h1ZmZsZVNwbGl0KG5fc3BsaXRzPTEsIHRlc3Rfc2l6ZT1zZWxmLnZhbF9zaXplLCByYW5kb21fc3RhdGU9c2VsZi5yYW5kb21fc3RhdGUpCiAgICAgICAgdHJhaW5faWR4LCB2YWxfaWR4ID0gbmV4dChzcGxpdC5zcGxpdCh0cmFpbl92YWxfZGF0YSwgdHJhaW5fdmFsX2RhdGFbc2VsZi5sYWJlbF9jb2x1bW5dKSkKICAgICAgICB0cmFpbl9zZXQgPSB0cmFpbl92YWxfZGF0YS5pbG9jW3RyYWluX2lkeF0ucmVzZXRfaW5kZXgoZHJvcD1UcnVlKQogICAgICAgIHZhbF9zZXQgPSB0cmFpbl92YWxfZGF0YS5pbG9jW3ZhbF9pZHhdLnJlc2V0X2luZGV4KGRyb3A9VHJ1ZSkKCiAgICAgICAgIyBDb252ZXJ0IHRvIEh1Z2dpbmcgRmFjZSBEYXRhc2V0RGljdAogICAgICAgIHNlbGYuZGF0YXNldCA9IERhdGFzZXREaWN0KHsKICAgICAgICAgICAgJ3RyYWluJzogRGF0YXNldC5mcm9tX3BhbmRhcyh0cmFpbl9zZXQpLAogICAgICAgICAgICAndmFsaWRhdGlvbic6IERhdGFzZXQuZnJvbV9wYW5kYXModmFsX3NldCksCiAgICAgICAgICAgICd0ZXN0JzogRGF0YXNldC5mcm9tX3BhbmRhcyh0ZXN0X3NldCkKICAgICAgICB9KQoKICAgIGRlZiBnZXRfZGF0YXNldChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBSZXRyaWV2ZXMgdGhlIGRhdGFzZXQgZGljdGlvbmFyeSBjb250YWluaW5nIHRyYWluLCB2YWxpZGF0aW9uLCBhbmQgdGVzdCBzZXRzLgoKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEYXRhc2V0RGljdDogQSBkaWN0aW9uYXJ5IGNvbnRhaW5pbmcgdGhlIHNwbGl0cyBhcyBIdWdnaW5nIEZhY2UgZGF0YXNldHMuCiAgICAgICAgIiIiCiAgICAgICAgaWYgc2VsZi5kYXRhc2V0IGlzIE5vbmU6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIkRhdGFzZXQgbm90IGNyZWF0ZWQuIENhbGwgc3RyYXRpZmllZF9zcGxpdCgpIGZpcnN0LiIpCiAgICAgICAgcmV0dXJuIHNlbGYuZGF0YXNldAoKICAgIGRlZiBnZXRfY2xhc3Nfd2VpZ2h0cyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBSZXRyaWV2ZXMgdGhlIGNsYXNzIHdlaWdodHMuCgogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHRvcmNoLkZsb2F0VGVuc29yOiBDbGFzcyB3ZWlnaHRzIGZvciBoYW5kbGluZyBpbWJhbGFuY2VkIGNsYXNzZXMuCiAgICAgICAgIiIiCiAgICAgICAgaWYgc2VsZi5jbGFzc193ZWlnaHRzIGlzIE5vbmU6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIkNsYXNzIHdlaWdodHMgbm90IGNvbXB1dGVkLiBDYWxsIGxvYWRfZGF0YSgpIGZpcnN0LiIpCiAgICAgICAgcmV0dXJuIHNlbGYuY2xhc3Nfd2VpZ2h0cwoKICAgIGRlZiBnZXRfbnVtX2xhYmVscyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBSZXRyaWV2ZXMgdGhlIG51bWJlciBvZiB1bmlxdWUgbGFiZWxzLgoKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBpbnQ6IE51bWJlciBvZiB1bmlxdWUgbGFiZWxzIGluIHRoZSBkYXRhc2V0LgogICAgICAgICIiIgogICAgICAgIGlmIHNlbGYubnVtX2xhYmVscyBpcyBOb25lOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJOdW1iZXIgb2YgbGFiZWxzIG5vdCBhdmFpbGFibGUuIENhbGwgbG9hZF9kYXRhKCkgZmlyc3QuIikKICAgICAgICByZXR1cm4gc2VsZi5udW1fbGFiZWxzCgogICAgZGVmIGdldF9lbmNvZGluZyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBSZXRyaWV2ZXMgdGhlIG1hcHBpbmcgb2YgbGFiZWxzIHRvIGNhdGVnb3JpZXMuCgogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGRpY3Q6IE1hcHBpbmcgb2YgbGFiZWwgSURzIHRvIHRoZWlyIHJlc3BlY3RpdmUgY2F0ZWdvcmllcy4KICAgICAgICAiIiIKICAgICAgICBpZiBzZWxmLmVuY29kaW5nIGlzIE5vbmU6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIkxhYmVsIG1hcHBpbmcgbm9uZXhpc3RlbnQuIENhbGwgbG9hZF9kYXRhKCkgZmlyc3QuIikKICAgICAgICByZXR1cm4gc2VsZi5lbmNvZGluZwoKICAgIGRlZiBnZXRfcl9lbmNvZGluZyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBSZXRyaWV2ZXMgdGhlIG1hcHBpbmcgb2YgbGFiZWxzIHRvIGNhdGVnb3JpZXMuCgogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGRpY3Q6IE1hcHBpbmcgb2YgbGFiZWwgSURzIHRvIHRoZWlyIHJlc3BlY3RpdmUgY2F0ZWdvcmllcy4KICAgICAgICAiIiIKICAgICAgICBpZiBzZWxmLnJldmVyc2VfZW5jb2RpbmcgaXMgTm9uZToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiTGFiZWwgbWFwcGluZyBub25leGlzdGVudC4gQ2FsbCBsb2FkX2RhdGEoKSBmaXJzdC4iKQogICAgICAgIHJldHVybiBzZWxmLnJldmVyc2VfZW5jb2RpbmcKCgpmcm9tIHRyYW5zZm9ybWVycyBpbXBvcnQgQXV0b1Rva2VuaXplcgoKY2xhc3MgVG9rZW5pemVyRnVuY3Rpb246CiAgICBkZWYgX19pbml0X18oc2VsZiwgbW9kZWxfbmFtZSwgbWF4X2xlbmd0aD01MTIsIHVzZV9mYXN0PVRydWUsIHVzZV9jYWNoZT1GYWxzZSk6CiAgICAgICAgIiIiCiAgICAgICAgSW5pdGlhbGl6ZSB0aGUgdG9rZW5pemVyIGZ1bmN0aW9uIHdyYXBwZXIg8J+MrwogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIG1vZGVsX25hbWUgKHN0cik6IE5hbWUgb2YgdGhlIHByZS10cmFpbmVkIG1vZGVsLgogICAgICAgICAgICBtYXhfbGVuZ3RoIChpbnQpOiBNYXhpbXVtIHNlcXVlbmNlIGxlbmd0aCBmb3IgdG9rZW5pemF0aW9uLgogICAgICAgICAgICB1c2VfZmFzdCAoYm9vbCk6IFdoZXRoZXIgdG8gdXNlIHRoZSBmYXN0IHRva2VuaXplciBpbXBsZW1lbnRhdGlvbi4KICAgICAgICAgICAgdXNlX2NhY2hlIChib29sKTogV2hldGhlciB0byBjYWNoZSB0aGUgdG9rZW5pemVyIHJlc3VsdHMuCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi50b2tlbml6ZXIgPSBBdXRvVG9rZW5pemVyLmZyb21fcHJldHJhaW5lZChtb2RlbF9uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZV9mYXN0PXVzZV9mYXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZV9jYWNoZT11c2VfY2FjaGUpCiAgICAgICAgc2VsZi5tYXhfbGVuZ3RoID0gbWF4X2xlbmd0aAoKICAgIGRlZiBfX2NhbGxfXyhzZWxmLCBkYXRhKToKICAgICAgICAiIiIKICAgICAgICBUb2tlbml6ZXMgdGhlIGlucHV0IGRhdGEuCgogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRhdGEgKGRpY3QpOiBBIGRpY3Rpb25hcnkgY29udGFpbmluZyB0aGUgJ3RleHQnIGZpZWxkIHRvIHRva2VuaXplLgoKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBkaWN0OiBUb2tlbml6ZWQgZGF0YSBpbmNsdWRpbmcgaW5wdXQgSURzLCBhdHRlbnRpb24gbWFza3MsIGV0Yy4KICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi50b2tlbml6ZXIoZGF0YVsndGV4dCddLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nPSdtYXhfbGVuZ3RoJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ1bmNhdGlvbj1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhfbGVuZ3RoPXNlbGYubWF4X2xlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuX3RlbnNvcnM9InB0IikKCiAgICBkZWYgZ2V0X3Rva2VuaXplcihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi50b2tlbml6ZXIKCgoKaW1wb3J0IHRvcmNoCmZyb20gdG9yY2ggaW1wb3J0IG5uCmZyb20gdG9yY2gudXRpbHMuZGF0YSBpbXBvcnQgRGF0YUxvYWRlcgpmcm9tIHRvcmNoLm9wdGltIGltcG9ydCBBZGFtVwpmcm9tIHRvcmNobWV0cmljcy5jbGFzc2lmaWNhdGlvbiBpbXBvcnQgTXVsdGljbGFzc0YxU2NvcmUsIEFjY3VyYWN5Cgpmcm9tIHRyYW5zZm9ybWVycyBpbXBvcnQgQXV0b01vZGVsRm9yU2VxdWVuY2VDbGFzc2lmaWNhdGlvbiwgQXV0b01vZGVsCmZyb20gdHJhbnNmb3JtZXJzIGltcG9ydCBQcmVUcmFpbmVkTW9kZWwKZnJvbSB0cmFuc2Zvcm1lcnMubW9kZWxpbmdfb3V0cHV0cyBpbXBvcnQgU2VxdWVuY2VDbGFzc2lmaWVyT3V0cHV0CmZyb20gdHJhbnNmb3JtZXJzIGltcG9ydCBBdXRvQ29uZmlnLCBUcmFpbmluZ0FyZ3VtZW50cywgRWFybHlTdG9wcGluZ0NhbGxiYWNrLCBUcmFpbmVyCgpmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRlLCBkYXRldGltZQppbXBvcnQgb3MKCmltcG9ydCBqc29uCmltcG9ydCBldmFsdWF0ZQoKY2xhc3MgQmVydEZvclNlbnRlbmNlQ2xhc3NpZmljYXRpb24oUHJlVHJhaW5lZE1vZGVsKToKCiAgICAiIiIKICAgIEJFUlQgYXJjaGl0ZWN0dXJlIGlzIGludGVuZGVkIHRvIGJlIGZyb20gImRibWR6L2JlcnQtYmFzZS1pdGFsaWFuLXh4bC1jYXNlZCIKICAgIGJ1dCBvdGhlciBtb2RlbHMgY2FuIGJlIHRyaWVkLgogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNvbmZpZywgbW9kZWxfbmFtZSwgbnVtX2xhYmVscywgY2xhc3Nfd2VpZ2h0cz1Ob25lKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKGNvbmZpZykKICAgICAgICBzZWxmLm51bV9sYWJlbHMgPSBudW1fbGFiZWxzCiAgICAgICAgc2VsZi5iZXJ0ID0gQXV0b01vZGVsLmZyb21fcHJldHJhaW5lZChtb2RlbF9uYW1lKQogICAgICAgIHNlbGYuY2xhc3NpZmllciA9IG5uLkxpbmVhcihzZWxmLmJlcnQuY29uZmlnLmhpZGRlbl9zaXplLCBudW1fbGFiZWxzKQogICAgICAgIHNlbGYuY2xhc3Nfd2VpZ2h0cyA9IGNsYXNzX3dlaWdodHMKICAgICAgICBzZWxmLmFjY3VyYWN5ID0gQWNjdXJhY3kobnVtX2NsYXNzZXM9bnVtX2xhYmVscywgdGFzaz0nbXVsdGljbGFzcycpCiAgICAgICAgc2VsZi5mMSA9IE11bHRpY2xhc3NGMVNjb3JlKG51bV9jbGFzc2VzPW51bV9sYWJlbHMsIGF2ZXJhZ2U9J21hY3JvJykgIyBjaGFuZ2VkIHdlaWdodCxtaWNybyBOb25lLCDigJhiaW5hcnnigJkgKGRlZmF1bHQpLCDigJhtaWNyb+KAmSwg4oCYbWFjcm/igJksIOKAmHNhbXBsZXPigJksIOKAmHdlaWdodGVk4oCZXQoKICAgIGRlZiBmb3J3YXJkKHNlbGYsIGlucHV0X2lkcywgYXR0ZW50aW9uX21hc2s9Tm9uZSwgbGFiZWxzPU5vbmUpOgogICAgICAgIG91dHB1dHMgPSBzZWxmLmJlcnQoaW5wdXRfaWRzPWlucHV0X2lkcywgYXR0ZW50aW9uX21hc2s9YXR0ZW50aW9uX21hc2spCiAgICAgICAgbG9naXRzID0gc2VsZi5jbGFzc2lmaWVyKG91dHB1dHMubGFzdF9oaWRkZW5fc3RhdGVbOiwgMCwgOl0pCgogICAgICAgIGxvc3MgPSBOb25lCiAgICAgICAgaWYgbGFiZWxzIGlzIG5vdCBOb25lOgoKICAgICAgICAgICAgbG9zc19mY3QgPSBubi5Dcm9zc0VudHJvcHlMb3NzKGxhYmVsX3Ntb290aGluZz0wLjEpICMsd2VpZ2h0PXNlbGYuY2xhc3Nfd2VpZ2h0cwogICAgICAgICAgICBsb3NzID0gbG9zc19mY3QobG9naXRzLCBsYWJlbHMpCgogICAgICAgICAgICBmMV9zY29yZSA9IHNlbGYuZjEobG9naXRzLmFyZ21heChkaW09MSksIGxhYmVscykKICAgICAgICAgICAgYWNjdXJhY3lfc2NvcmUgPSBzZWxmLmFjY3VyYWN5KGxvZ2l0cy5hcmdtYXgoZGltPTEpLCBsYWJlbHMpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIFNlcXVlbmNlQ2xhc3NpZmllck91dHB1dChsb3NzPWxvc3MsIGxvZ2l0cz1sb2dpdHMpCgpjbGFzcyBUcmFpbmVySGFuZGxlcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB0cmFpbmVyLCB0b2tlbml6ZWRfZGF0YXNldHMsIG51bV9sYWJlbHMsIGVuY29kaW5nLCBtb2RlbF9uYW1lLAogICAgICAgICAgICAgICAgIG1vZGVsX3NhdmVfcGF0aCk6CiAgICAgICAgIiIiCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdHJhaW5lcjogSHVnZ2luZyBGYWNlIFRyYWluZXIgaW5zdGFuY2UuCiAgICAgICAgICAgIHRva2VuaXplZF9kYXRhc2V0czogRGF0YXNldERpY3Qgd2l0aCB0cmFpbi92YWwvdGVzdCBzcGxpdHMuCiAgICAgICAgICAgIG51bV9sYWJlbHM6IE51bWJlciBvZiBsYWJlbHMgaW4gdGhlIGNsYXNzaWZpY2F0aW9uIHRhc2suCiAgICAgICAgICAgIGVuY29kaW5nOiBNYXBwaW5nIGZyb20gZGVuc2UgdG8gc3BhcnNlIG9yaWdpbmFsIGxhYmVsbGluZy4KICAgICAgICAgICAgbW9kZWxfbmFtZQogICAgICAgICAgICBtb2RlbF9zYXZlX3BhdGg6IFBhdGggdG8gc2F2ZSB0aGUgY29uZmlndXJhdGlvbiwgd2VpZ2h0cyBhbmQgdG9rZW5pemVyIGZvciByZXByb2R1Y2liaWxpdHkuCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi50cmFpbmVyID0gdHJhaW5lcgogICAgICAgIHNlbGYudG9rZW5pemVkX2RhdGFzZXRzID0gdG9rZW5pemVkX2RhdGFzZXRzCiAgICAgICAgc2VsZi5udW1fbGFiZWxzID0gbnVtX2xhYmVscwogICAgICAgIHNlbGYuZW5jb2RpbmcgPSBlbmNvZGluZwogICAgICAgIHNlbGYubW9kZWxfbmFtZSA9IG1vZGVsX25hbWUKICAgICAgICBzZWxmLm1vZGVsX3NhdmVfcGF0aCA9IG1vZGVsX3NhdmVfcGF0aAoKICAgIGRlZiBjb21wdXRlX2YxX3Njb3JlKHNlbGYsIHByZWRpY3Rpb25zKToKICAgICAgICAiIiIKICAgICAgICBNaWNybyBGMSBzY29yZSBmcm9tCgogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHByZWRpY3Rpb25zOiBPdXRwdXQgZnJvbSB0aGUgdHJhaW5lci5wcmVkaWN0KCkgbWV0aG9kLgoKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBmMV9zY29yZTogVGhlIGNhbGN1bGF0ZWQgRjEgc2NvcmUuCiAgICAgICAgIiIiCiAgICAgICAgbG9naXRzID0gdG9yY2gudGVuc29yKHByZWRpY3Rpb25zLnByZWRpY3Rpb25zKQogICAgICAgIGxhYmVscyA9IHRvcmNoLnRlbnNvcihwcmVkaWN0aW9ucy5sYWJlbF9pZHMpCiAgICAgICAgZjEgPSBNdWx0aWNsYXNzRjFTY29yZShudW1fY2xhc3Nlcz1zZWxmLm51bV9sYWJlbHMsIGF2ZXJhZ2U9J21pY3JvJykgIyB3ZWlnaHQKICAgICAgICBmMV9zY29yZSA9IGYxKGxvZ2l0cy5hcmdtYXgoZGltPTEpLCBsYWJlbHMuZmxvYXQoKSkKICAgICAgICByZXR1cm4gZjFfc2NvcmUsIGxvZ2l0cywgbGFiZWxzCgogICAgZGVmIHNhdmVfZjFfcmVzdWx0cyhzZWxmLCBmMV9zY29yZSk6CiAgICAgICAgIiIiCiAgICAgICAgU2F2ZSB0aGUgRjEgc2NvcmUgdG8gYSBDU1YgZmlsZS4KCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZjFfc2NvcmU6IGJ5IGRlZmF1bHQsIGl0J3MgdGhlIG1pY3JvIEYxIHdlaWdodGVkIG9uIGNsYXNzIGZyZXF1ZW5jeS4KICAgICAgICAiIiIKICAgICAgICBub3cgPSBkYXRldGltZS50b2RheSgpCiAgICAgICAgCiAgICAgICAgY3N2RmlsZSA9IHNlbGYubW9kZWxfc2F2ZV9wYXRoICsgJy8nICsgIGYne3NlbGYubW9kZWxfbmFtZX0uY3N2JzsKCiAgICAgICAgZGYgPSBwZC5EYXRhRnJhbWUoewogICAgICAgICAgICAnRjEnOiBbZjFfc2NvcmUuaXRlbSgpXSwKICAgICAgICAgICAgJ21vZGVsbG8nOiBbc2VsZi5tb2RlbF9uYW1lXSwKICAgICAgICAgICAgJ1QnOiBbbm93XSwKICAgICAgICB9KQogICAgICAgIAogICAgICAgIGlmIG5vdCBvcy5wYXRoLmlzZmlsZShjc3ZGaWxlKToKICAgICAgICAgICAgZGYudG9fY3N2KGNzdkZpbGUsIGhlYWRlcj0nY29sdW1uX25hbWVzJywgaW5kZXg9RmFsc2UpCiAgICAgICAgZWxzZTogICMgZWxzZSBpdCBleGlzdHMgc28gYXBwZW5kIHdpdGhvdXQgd3JpdGluZyB0aGUgaGVhZGVyCiAgICAgICAgICAgIGRmLnRvX2Nzdihjc3ZGaWxlLCBtb2RlPSdhJywgaGVhZGVyPUZhbHNlLCBpbmRleD1GYWxzZSkgICAgICAgIAogICAgICAgIAogICAgICAgIHByaW50KGYiRjEgc2NvcmUgc2F2ZWQgdG8ge3NlbGYubW9kZWxfbmFtZX0uY3N2IikKCiAgICBkZWYgc2F2ZV9wcmVkaWN0aW9ucyhzZWxmLCBsb2dpdHMsIGxhYmVscyk6CiAgICAgICAgIiIiCiAgICAgICAgU2F2ZSBwcmVkaWN0ZWQgYW5kIHRydWUgbGFiZWxzIHRvIGEgQ1NWIGZpbGUuCgogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGxvZ2l0czogTW9kZWwgbG9naXRzIGZyb20gdGhlIHByZWRpY3Rpb25zLgogICAgICAgICAgICBsYWJlbHM6IEdyb3VuZCB0cnV0aCBsYWJlbCBpbmRleGVzIGZyb20gdGhlIHByZWRpY3Rpb25zLgogICAgICAgICIiIgogICAgICAgIG5vdyA9IGRhdGV0aW1lLnRvZGF5KCkKICAgICAgICBpbnZlcnRlZF9lbmNvZGluZyA9IHtpbnQodik6IGsgZm9yIGssIHYgaW4gc2VsZi5lbmNvZGluZy5pdGVtcygpfQogICAgICAgIHByZWRpY3RlZF9pbmRpY2VzID0gbG9naXRzLmFyZ21heChkaW09MSkKICAgICAgICBwcmVkaWN0ZWRfbGFiZWxzID0gW2ludmVydGVkX2VuY29kaW5nW2lkeC5pdGVtKCldIGZvciBpZHggaW4gcHJlZGljdGVkX2luZGljZXNdCiAgICAgICAgdHJ1ZV9sYWJlbHMgPSBbaW52ZXJ0ZWRfZW5jb2RpbmdbaWR4Lml0ZW0oKV0gZm9yIGlkeCBpbiBsYWJlbHNdCgogICAgICAgIG9yaWdpbmFsX2luZGV4ID0gc2VsZi50b2tlbml6ZWRfZGF0YXNldHNbJ3Rlc3QnXVsnaW5kZXgnXSAjb3JpZ2luYWwgaW5kZXhlcyBmb3IgdGVzdCBvYnNlcnZhdGlvbnMgaW4gdGhlIGlucHV0IGRmCgogICAgICAgIHJlc3VsdHMgPSBwZC5EYXRhRnJhbWUoewogICAgICAgICAgICAnb3JpZ2luYWxfaW5kZXgnOiBvcmlnaW5hbF9pbmRleCwKICAgICAgICAgICAgJ3RydWVfbGFiZWwnOiB0cnVlX2xhYmVscywKICAgICAgICAgICAgJ3ByZWRpY3RlZF9sYWJlbCc6IHByZWRpY3RlZF9sYWJlbHMsCiAgICAgICAgfSkKCiAgICAgICAgcmVzdWx0cy50cnVlX2xhYmVsLCByZXN1bHRzLnByZWRpY3RlZF9sYWJlbCA9IHJlc3VsdHMudHJ1ZV9sYWJlbCArIDEsIHJlc3VsdHMucHJlZGljdGVkX2xhYmVsICsgMQoKICAgICAgICBmaWxlX25hbWUgPSBmJ3tzZWxmLm1vZGVsX25hbWV9X3tub3cubW9udGh9X3tub3cuZGF5fS17bm93LmhvdXJ9X3tub3cubWludXRlfS5jc3YnCiAgICAgICAgcmVzdWx0cy50b19jc3Yoc2VsZi5tb2RlbF9zYXZlX3BhdGggKyAnLycgKyBmaWxlX25hbWUsIGluZGV4PUZhbHNlKQogICAgICAgIHByaW50KGYiUHJlZGljdGlvbnMgc2F2ZWQgdG8ge2ZpbGVfbmFtZX0iKQoKICAgIGRlZiBzYXZlX21vZGVsX2FuZF90b2tlbml6ZXIoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgU2F2ZSB0aGUgdHJhaW5lZCBtb2RlbCBhbmQgdG9rZW5pemVyIHRvIHRoZSBzcGVjaWZpZWQgcGF0aC4KICAgICAgICAiIiIKICAgICAgICBwcmludChmIlNhdmluZyB0aGUgdHJhaW5lZCBtb2RlbCBhcyB7c2VsZi5tb2RlbF9uYW1lfS4uLiIpCiAgICAgICAgc2VsZi50cmFpbmVyLm1vZGVsLnNhdmVfcHJldHJhaW5lZChzZWxmLm1vZGVsX3NhdmVfcGF0aCkKICAgICAgICBzZWxmLnRyYWluZXIudG9rZW5pemVyLnNhdmVfcHJldHJhaW5lZChzZWxmLm1vZGVsX3NhdmVfcGF0aCkKICAgICAgICBwcmludChmIk1vZGVsIGFuZCB0b2tlbml6ZXIgc2F2ZWQgdG8ge3NlbGYubW9kZWxfc2F2ZV9wYXRofSIpCgogICAgZGVmIHJ1bihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBFeGVjdXRlIHRoZSB0cmFpbmluZyBhbmQgc2F2ZSB0aGUgb3V0cHV0cy4KICAgICAgICAiIiIKICAgICAgICBwcmludCgiU3RhcnRpbmcgdHJhaW5pbmcuLi4iKQogICAgICAgICNzZWxmLnRyYWluZXIudHJhaW4ocmVzdW1lX2Zyb21fY2hlY2twb2ludD1UcnVlKQogICAgICAgIHNlbGYudHJhaW5lci50cmFpbigpCiAgICAgICAgc2VsZi50cmFpbmVyLnNhdmVfc3RhdGUoKQoKICAgICAgICBwcmludCgiRXZhbHVhdGluZyB0ZXN0IHNldC4uLiIpCiAgICAgICAgcHJlZGljdGlvbnMgPSBzZWxmLnRyYWluZXIucHJlZGljdChzZWxmLnRva2VuaXplZF9kYXRhc2V0c1sndGVzdCddKQoKICAgICAgICBmMV9zY29yZSwgbG9naXRzLCBsYWJlbHMgPSBzZWxmLmNvbXB1dGVfZjFfc2NvcmUocHJlZGljdGlvbnMpCiAgICAgICAgcHJpbnQoZiJGMSBzY29yZToge2YxX3Njb3JlLml0ZW0oKX1cbiIpCgogICAgICAgIHNlbGYuc2F2ZV9mMV9yZXN1bHRzKGYxX3Njb3JlKQogICAgICAgIHNlbGYuc2F2ZV9wcmVkaWN0aW9ucyhsb2dpdHMsIGxhYmVscykKICAgICAgICBzZWxmLnNhdmVfbW9kZWxfYW5kX3Rva2VuaXplcigpCiAgICAgICAgcHJpbnQoIkRvbmUuIikKCmRlZiBjb21wdXRlX21ldHJpY3MocHJlZCk6CiAgICAnJycKICAgIHNhdmUgcGVyZm9ybWFuY2UgbWV0cmljcwogICAgQWRhcHRlZCBmcm9tIHByZXZpb3VzIHZlcnNpb24gdG8gcnVuIGFsc28gd2hpbGUgdHJhaW5pbmcKICAgIEl0IGFwcGVuZHMgb25lIGxpbmUgdG8gYSBjc3YgbG9nIGluc3RlYWQgb2YgbG9hZGluZyBpdCAtIGZvciBlYWNoIGVwb2NoCiAgICAnJycKICAgIGxvZ2l0cywgbGFiZWxzID0gcHJlZAoKICAgIG1ldHJpY3MgPSBbImYxIiwgImFjY3VyYWN5IiwgInJlY2FsbCIsICJwcmVjaXNpb24iXQogICAgbWV0cmljID0ge30KICAgIGZvciBtZXQgaW4gbWV0cmljczoKICAgICAgICBtZXRyaWNbbWV0XSA9IGV2YWx1YXRlLmxvYWQobWV0KQogICAgcHJlZGljdGlvbnMgPSBucC5hcmdtYXgobG9naXRzLCBheGlzPS0xKQogICAgbWV0cmljX3JlcyA9IHt9CiAgICBmb3IgbWV0IGluIG1ldHJpY3M6CiAgICAgICAgaWYgKG1ldCAhPSAnYWNjdXJhY3knKToKICAgICAgICAgICAgbWV0cmljX3Jlc1ttZXRdID0gbWV0cmljW21ldF0uY29tcHV0ZShwcmVkaWN0aW9ucz1wcmVkaWN0aW9ucywgcmVmZXJlbmNlcz1sYWJlbHMsIGF2ZXJhZ2U9J21hY3JvJylbbWV0XQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1ldHJpY19yZXNbbWV0XSA9IG1ldHJpY1ttZXRdLmNvbXB1dGUocHJlZGljdGlvbnM9cHJlZGljdGlvbnMsIHJlZmVyZW5jZXM9bGFiZWxzKVttZXRdCgogICAgaWYgbm90IHBhdGguZXhpc3RzKG1vZGVsX2Rpcik6CiAgICAgICAgbWFrZWRpcnMobW9kZWxfZGlyKQogICAgICAgIAogICAgZGF0YV9maWxlbmFtZSA9ICd0cmFpbl9tZXRyaWNzLmNzdicKICAgIHJvdyA9IHBkLkRhdGFGcmFtZSh7azogW3ZdIGZvciBrLCB2IGluIG1ldHJpY19yZXMuaXRlbXMoKX0pCiAgICAjcHJpbnQoJ1xuU2F2aW5nIHRyYWluaW5nIG1ldHJpY3NcbicpICAjREVCVUdHSU5HCgogICAgZGF0YWZyYW1lX2FwcGVuZChkaXJlY3Rvcnk9bW9kZWxfZGlyLCBkYXRhX2ZpbGVuYW1lPWRhdGFfZmlsZW5hbWUsIHJvdz1yb3cpCgogICAgcmV0dXJuIG1ldHJpY19yZXMKICAgIApkZWYgZGF0YWZyYW1lX2FwcGVuZChkaXJlY3RvcnksIGRhdGFfZmlsZW5hbWUsIHJvdyk6CiAgICAjIG1vZHVsZSBmb3IgdXNlIGluIGRpZmZlcmVudCBzdGFnZXMgb2YgdHJhaW5pbmcgYW5kIHRlc3RpbmcKICAgIGlmIG5vdCBwYXRoLmV4aXN0cyhtb2RlbF9kaXIpOgogICAgICAgIG1ha2VkaXJzKG1vZGVsX2RpcikKICAgIEZOID0gZGlyZWN0b3J5ICsgJy8nICsgZGF0YV9maWxlbmFtZQoKICAgIGlmIG5vdCAocGF0aC5leGlzdHMoRk4pKToKICAgICAgICByb3cudG9fY3N2KEZOLCBpbmRleD1GYWxzZSwgaGVhZGVyPVRydWUpCiAgICBlbHNlOgogICAgICAgIHJvdy50b19jc3YoRk4sIG1vZGU9J2EnLCBpbmRleD1GYWxzZSwgaGVhZGVyPUZhbHNlKQoKCmZpbGVfYmFzZXBhdGggPSAiL2xvY2FsX2RhdGEiCgpkZWYgdHJhaW4ocHJvamVjdCwKICAgICAgICAgIHRyYWluX2RhdGEsCiAgICAgICAgICB0YXJnZXRfbW9kZWxfbmFtZT0iIiwKICAgICAgICAgIG51bV90cmFpbl9lcG9jaHM9MywKICAgICAgICAgIHBlcl9kZXZpY2VfdHJhaW5fYmF0Y2hfc2l6ZT0xNiwKICAgICAgICAgIHBlcl9kZXZpY2VfZXZhbF9iYXRjaF9zaXplPTE2LAogICAgICAgICAgZ3JhZGllbnRfYWNjdW11bGF0aW9uX3N0ZXBzPTIsCiAgICAgICAgICB3ZWlnaHRfZGVjYXk9MC4wMDUsCiAgICAgICAgICBsZWFybmluZ19yYXRlPTFlLTUsCiAgICAgICAgICBscl9zY2hlZHVsZXJfdHlwZT0nbGluZWFyJyk6CgogICAgZ2xvYmFsIG1vZGVsX2RpcgogICAgbW9kZWxfZGlyID0gZiJ7ZmlsZV9iYXNlcGF0aH0vbW9kZWwiCiAgICBkYXRhX2RpciA9IGYie2ZpbGVfYmFzZXBhdGh9L2RhdGEiCiAgICBsb2dnaW5nX2RpciA9IGYie2ZpbGVfYmFzZXBhdGh9L2xvZ2dpbmciCiAgICBvdXRwdXRfZGlyID0gZiJ7ZmlsZV9iYXNlcGF0aH0vdHVuZWRfbW9kZWwiCiAgICAKICAgIHRyeToKICAgICAgICBzaHV0aWwucm10cmVlKGRhdGFfZGlyKQogICAgZXhjZXB0OgogICAgICAgIHByaW50KCJFcnJvciBkZWxldGluZyBkYXRhIGRpciIpCiAgICAgICAgICAgICAgICAKICAgICMgQ3JlYXRlIHRoZSBkaXJlY3RvcnkgZm9yIHRoZSBkYXRhCiAgICBpZiBub3QgcGF0aC5leGlzdHMoZGF0YV9kaXIpOgogICAgICAgIG1ha2VkaXJzKGRhdGFfZGlyKQoKICAgIGRhdGFfZmlsZSA9IHRyYWluX2RhdGEuZG93bmxvYWQoZGF0YV9kaXIpICMgdGhpcyBtdXN0IGNoYW5nZSBpbiB0aGUgZnVuY3Rpb24KCiAgICBpZiBub3QgcGF0aC5leGlzdHMoZGF0YV9kaXIpOgogICAgICAgIG1ha2VkaXJzKGRhdGFfZGlyKQoKICAgIAogICAgdHJ5OgogICAgICAgIHNodXRpbC5ybXRyZWUobW9kZWxfZGlyKQogICAgZXhjZXB0OgogICAgICAgIHByaW50KCJFcnJvciBkZWxldGluZyBtb2RlbCBkaXIiKQogICAgICAgIAogICAgICMgQ3JlYXRlIHRoZSBkaXJlY3RvcnkgZm9yIHRoZSBtb2RlbAogICAgaWYgbm90IHBhdGguZXhpc3RzKG1vZGVsX2Rpcik6CiAgICAgICAgbWFrZWRpcnMobW9kZWxfZGlyKSAgICAKICAgIGlmIG5vdCBwYXRoLmV4aXN0cyhsb2dnaW5nX2Rpcik6CiAgICAgICAgbWFrZWRpcnMobG9nZ2luZ19kaXIpICAgIAogICAgaWYgbm90IHBhdGguZXhpc3RzKG91dHB1dF9kaXIpOgogICAgICAgIG1ha2VkaXJzKG91dHB1dF9kaXIpICAgIAoKICAgIG1vZGVsX3BhcmFtcyA9IHsKICAgICAgICAibnVtX3RyYWluX2Vwb2NocyI6IG51bV90cmFpbl9lcG9jaHMsCiAgICAgICAgInBlcl9kZXZpY2VfdHJhaW5fYmF0Y2hfc2l6ZSI6IHBlcl9kZXZpY2VfdHJhaW5fYmF0Y2hfc2l6ZSwKICAgICAgICAicGVyX2RldmljZV9ldmFsX2JhdGNoX3NpemUiOiBwZXJfZGV2aWNlX2V2YWxfYmF0Y2hfc2l6ZSwKICAgICAgICAiZ3JhZGllbnRfYWNjdW11bGF0aW9uX3N0ZXBzIjogZ3JhZGllbnRfYWNjdW11bGF0aW9uX3N0ZXBzLAogICAgICAgICJ3ZWlnaHRfZGVjYXkiOiB3ZWlnaHRfZGVjYXksCiAgICAgICAgImxlYXJuaW5nX3JhdGUiOiBsZWFybmluZ19yYXRlLAogICAgICAgICJscl9zY2hlZHVsZXJfdHlwZSI6IGxyX3NjaGVkdWxlcl90eXBlCiAgICB9CiAgICAgICAgICAgICAgCiAgICBtb2RlbF9uYW1lID0gImRibWR6L2JlcnQtYmFzZS1pdGFsaWFuLXh4bC1jYXNlZCIKICAgIGRhdGFsb2FkZXIgPSBEYXRhbG9hZGVyKGZpbGVfcGF0aCA9IGRhdGFfZmlsZSkKICAgIGRhdGFsb2FkZXIubG9hZF9kYXRhKCkKICAgIGRhdGFsb2FkZXIuc3RyYXRpZmllZF9zcGxpdCgpCiAgICBkYXRhc2V0ID0gZGF0YWxvYWRlci5nZXRfZGF0YXNldCgpCiAgICAjIGNsYXNzX3dlaWdodHMgPSBkYXRhbG9hZGVyLmdldF9jbGFzc193ZWlnaHRzKCkKICAgIG51bV9sYWJlbHMgPSBkYXRhbG9hZGVyLmdldF9udW1fbGFiZWxzKCkKICAgIGVuY29kaW5nID0gZGF0YWxvYWRlci5nZXRfZW5jb2RpbmcoKQogICAgdG9rZW5pemVfZnVuY3Rpb24gPSBUb2tlbml6ZXJGdW5jdGlvbihtb2RlbF9uYW1lPW1vZGVsX25hbWUsIG1heF9sZW5ndGg9NTEyKQogICAgdG9rZW5pemVkX2RhdGFzZXRzID0gKGRhdGFzZXQubWFwKHRva2VuaXplX2Z1bmN0aW9uLCBiYXRjaGVkPVRydWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgLnNodWZmbGUoc2VlZD0yNSkKICAgICAgICAgICAgICAgICAgICAgICAgICAucmVtb3ZlX2NvbHVtbnMoWyd0ZXh0JywgJ3Rva2VuX3R5cGVfaWRzJ10pKQogICAgcHJpbnQoZictLUxvYWRpbmcgdGhlIG1vZGVsIGZvciBwcmVkaWN0aW5nIHtudW1fbGFiZWxzfSBsYWJlbHMtLScpCiAgICBjb25maWcgPSBBdXRvQ29uZmlnLmZyb21fcHJldHJhaW5lZChtb2RlbF9uYW1lLCBudW1fbGFiZWxzPW51bV9sYWJlbHMpICAjZm9yIGxhdGVyIHNhdmluZyB0aGUgY29uZmlnCiAgICBtb2RlbCA9IChCZXJ0Rm9yU2VudGVuY2VDbGFzc2lmaWNhdGlvbgogICAgICAgICAuZnJvbV9wcmV0cmFpbmVkKHByZXRyYWluZWRfbW9kZWxfbmFtZV9vcl9wYXRoPW1vZGVsX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWxfbmFtZT1tb2RlbF9uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZz1jb25maWcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtX2xhYmVscz1udW1fbGFiZWxzKSkgI2NsYXNzX3dlaWdodHM9Y2xhc3Nfd2VpZ2h0cwogICAgdHJhaW5pbmdfYXJncyA9IFRyYWluaW5nQXJndW1lbnRzKAogICAgICAgIG91dHB1dF9kaXI9b3V0cHV0X2RpciwKICAgICAgICBsb2dnaW5nX2Rpcj1sb2dnaW5nX2RpciwKICAgICAgICBldmFsX3N0cmF0ZWd5PSdlcG9jaCcsCiAgICAgICAgc2F2ZV9zdHJhdGVneT0nZXBvY2gnLAogICAgICAgIHNhdmVfdG90YWxfbGltaXQ9MiwKICAgICAgICBudW1fdHJhaW5fZXBvY2hzPW51bV90cmFpbl9lcG9jaHMsCiAgICAgICAgcGVyX2RldmljZV90cmFpbl9iYXRjaF9zaXplPXBlcl9kZXZpY2VfdHJhaW5fYmF0Y2hfc2l6ZSwKICAgICAgICBwZXJfZGV2aWNlX2V2YWxfYmF0Y2hfc2l6ZT1wZXJfZGV2aWNlX2V2YWxfYmF0Y2hfc2l6ZSwKICAgICAgICBncmFkaWVudF9hY2N1bXVsYXRpb25fc3RlcHM9Z3JhZGllbnRfYWNjdW11bGF0aW9uX3N0ZXBzLAogICAgICAgIHdlaWdodF9kZWNheT13ZWlnaHRfZGVjYXksCiAgICAgICAgbGVhcm5pbmdfcmF0ZT1sZWFybmluZ19yYXRlLAogICAgICAgIGxyX3NjaGVkdWxlcl90eXBlPWxyX3NjaGVkdWxlcl90eXBlLAogICAgICAgIGxvYWRfYmVzdF9tb2RlbF9hdF9lbmQ9VHJ1ZSwKICAgICAgICBldmFsdWF0aW9uX3N0cmF0ZWd5ID0gImVwb2NoIiwgI1RvIGNhbGN1bGF0ZSBtZXRyaWNzIHBlciBlcG9jaAogICAgICAgIGxvZ2dpbmdfc3RyYXRlZ3k9ImVwb2NoIgogICAgICAgIAogICAgKQogICAgdHJhaW5lciA9IFRyYWluZXIoCiAgICAgICAgbW9kZWw9bW9kZWwsCiAgICAgICAgYXJncz10cmFpbmluZ19hcmdzLAogICAgICAgIHRyYWluX2RhdGFzZXQ9dG9rZW5pemVkX2RhdGFzZXRzWyd0cmFpbiddLAogICAgICAgIGV2YWxfZGF0YXNldD10b2tlbml6ZWRfZGF0YXNldHNbJ3ZhbGlkYXRpb24nXSwKICAgICAgICBjYWxsYmFja3M9W0Vhcmx5U3RvcHBpbmdDYWxsYmFjayhlYXJseV9zdG9wcGluZ19wYXRpZW5jZT0xKV0sCiAgICAgICAgY29tcHV0ZV9tZXRyaWNzPWNvbXB1dGVfbWV0cmljcwogICAgKQogICAgdHJhaW5lci50b2tlbml6ZXIgPSB0b2tlbml6ZV9mdW5jdGlvbi5nZXRfdG9rZW5pemVyKCkKICAgIAogICAgaGFuZGxlciA9IFRyYWluZXJIYW5kbGVyKAogICAgICAgIHRyYWluZXI9dHJhaW5lciwKICAgICAgICB0b2tlbml6ZWRfZGF0YXNldHM9dG9rZW5pemVkX2RhdGFzZXRzLAogICAgICAgIG51bV9sYWJlbHM9bnVtX2xhYmVscywKICAgICAgICBlbmNvZGluZz1lbmNvZGluZywKICAgICAgICBtb2RlbF9uYW1lPXRhcmdldF9tb2RlbF9uYW1lLAogICAgICAgIG1vZGVsX3NhdmVfcGF0aD1tb2RlbF9kaXIKICAgICkKICAgIGhhbmRsZXIucnVuKCkKCiAgICAjIG1ldHJpY3M9e30KICAgICMgZGYgPSBwZC5yZWFkX2Nzdihtb2RlbF9kaXIgKyAnLycgKyAgZid7dGFyZ2V0X21vZGVsX25hbWV9LmNzdicpCiAgICAjIGxhc3Rfcm93ID0gZGYudGFpbCgxKQogICAgIyBtZXRyaWNzWydGMSddID0gbGFzdF9yb3dbJ0YxJ10udmFsdWVzWzBdCiAgICAjIGZvciBrZXksIHZhbHVlIGluIGRmLml0ZXJyb3dzKCk6CiAgICAjICAgICBtZXRyaWNzW2YnRjFfZXBvY2h7a2V5KzF9J10gPSB2YWx1ZVsnRjEnXQogICAgCiAgICBkZiA9IHBkLnJlYWRfY3N2KG1vZGVsX2RpciArICcvdHJhaW5fbWV0cmljcy5jc3YnKQogICAgbGFzdF9yb3cgPSBkZi50YWlsKDEpCiAgICBtb2RlbF9tZXRyaWNzID0gWyJmMSIsImFjY3VyYWN5IiwgInJlY2FsbCIsICJwcmVjaXNpb24iXQogICAgbWV0cmljcyA9IHt9CiAgICBmb3IgbWV0IGluIG1vZGVsX21ldHJpY3M6ICAgIAogICAgICAgIG1ldHJpY3NbbWV0XSA9IGxhc3Rfcm93W21ldF0udmFsdWVzWzBdCiAgICBtZGwgPSBwcm9qZWN0LmxvZ19tb2RlbCgKICAgICAgICBuYW1lPXRhcmdldF9tb2RlbF9uYW1lLAogICAgICAgIGtpbmQ9Imh1Z2dpbmdmYWNlIiwKICAgICAgICBiYXNlX21vZGVsPSJkYm1kei9iZXJ0LWJhc2UtaXRhbGlhbi14eGwtY2FzZWQiLAogICAgICAgIHBhcmFtZXRlcnM9bW9kZWxfcGFyYW1zLAogICAgICAgIHNvdXJjZT1tb2RlbF9kaXIsCiAgICApICAgICAgICAgICAgCiAgICBmb3IgayBpbiBtZXRyaWNzOgogICAgICAgIG1kbC5sb2dfbWV0cmljKGssIG1ldHJpY3Nba10pCg==
    lang: python
