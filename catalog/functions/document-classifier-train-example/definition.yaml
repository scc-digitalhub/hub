kind: python
metadata:
  name: Document Classifier Training With Bert Model (Python Job)
  version: 1.0.0
  description: "Document classifier relying on LLM implementations for different languages. This example uses Italian language BERT model (dbmdz/bert-base-italian-xxl-cased) for document classification. Built using HuggingFace transformers library."
  labels: # key-value pairs to classify the function
    - "license:apache-2.0"
    - "domain:nlp"
    - "platform:0.14"
    - "type:job"
    - "phase:model-training"
    - "framework:pytorch"
    - "application:pa"
name: document-classifier-train
spec:
  python_version: PYTHON3_10
  requirements:
    - accelerate==1.1.1
    - evaluate
    - datasets==3.1.0
    - torch==2.5.1
    - torch_tensorrt==2.5.0
    - torchmetrics==1.6.0
    - torchtext==0.18.0
    - transformer_engine==1.12.0
    - transformer_engine_cu12==1.12.0
    - transformers==4.46.3
    - pandas==2.2.3
    - numpy==2.1.3
    - numpyencoder==0.3.0
    - scikit-learn==1.5.2
    - scipy==1.14.1
    - GitPython==3.1.43
    - attrs==24.2.0
    - async-timeout==5.0.1
    - aiosignal==1.3.1
    - aiohappyeyeballs==2.4.4
    - aiohttp==3.11.9
    - Unidecode==1.3.8
  source:
    handler: train
    base64: CmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBqc29uCmltcG9ydCB0b3JjaApmcm9tIG51bXB5ZW5jb2RlciBpbXBvcnQgTnVtcHlFbmNvZGVyCmZyb20gc2tsZWFybi5tb2RlbF9zZWxlY3Rpb24gaW1wb3J0IFN0cmF0aWZpZWRTaHVmZmxlU3BsaXQKZnJvbSBkYXRhc2V0cyBpbXBvcnQgRGF0YXNldCwgRGF0YXNldERpY3QKZnJvbSBvcyBpbXBvcnQgcGF0aCwgbWFrZWRpcnMsIGxpc3RkaXIKCmNsYXNzIERhdGFsb2FkZXI6CiAgICBkZWYgX19pbml0X18oc2VsZiwgZmlsZV9wYXRoLCBmaWxlX3R5cGU9Tm9uZSwgbGFiZWxfY29sdW1uPSdsYWJlbCcsIHRlc3Rfc2l6ZT0wLjIsIHZhbF9zaXplPTAuMjUsIHJhbmRvbV9zdGF0ZT0yNSwgKiprd2FyZ3MpOgogICAgICAgICIiIgogICAgICAgIEluaXRpYWxpemUgdGhlIERhdGFsb2FkZXIgb2JqZWN0IGZvciB0cmFpbmluZyBDdXN0b21CZXJ0Rm9yU2VxdWVuY2VDbGFzc2lmaWNhdGlvbgogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGZpbGVfcGF0aCAoc3RyKTogUGF0aCB0byB0aGUgcGFycXVldCBmaWxlLgogICAgICAgICAgICBsYWJlbF9jb2x1bW4gKHN0cik6IFRoZSBjb2x1bW4gbmFtZSByZXByZXNlbnRpbmcgbGFiZWxzIGluIHRoZSBkYXRhc2V0LgogICAgICAgICAgICB0ZXN0X3NpemUgKGZsb2F0KTogUHJvcG9ydGlvbiBvZiB0aGUgZGF0YXNldCB0byB1c2UgYXMgdGhlIHRlc3Qgc2V0LgogICAgICAgICAgICB2YWxfc2l6ZSAoZmxvYXQpOiBQcm9wb3J0aW9uIG9mIHRoZSB0cmFpbi92YWxpZGF0aW9uIHNwbGl0IHRvIHVzZSBhcyB0aGUgdmFsaWRhdGlvbiBzZXQuCiAgICAgICAgICAgIHJhbmRvbV9zdGF0ZSAoaW50KTogU2VlZCBmb3IgcmVwcm9kdWNpYmlsaXR5LgogICAgICAgICIiIgogICAgICAgIHNlbGYuZmlsZV9wYXRoID0gZmlsZV9wYXRoCiAgICAgICAgc2VsZi5maWxlX3R5cGUgPSBmaWxlX3BhdGguc3BsaXQoJy4nKVstMV0KICAgICAgICBzZWxmLmxhYmVsX2NvbHVtbiA9IGxhYmVsX2NvbHVtbgogICAgICAgIHNlbGYudGVzdF9zaXplID0gdGVzdF9zaXplCiAgICAgICAgc2VsZi52YWxfc2l6ZSA9IHZhbF9zaXplCiAgICAgICAgc2VsZi5yYW5kb21fc3RhdGUgPSByYW5kb21fc3RhdGUKICAgICAgICBzZWxmLmt3YXJncyA9IGt3YXJncwogICAgICAgIHNlbGYuZGYgPSBOb25lCiAgICAgICAgc2VsZi5kYXRhc2V0ID0gTm9uZQogICAgICAgIHNlbGYubnVtX2xhYmVscyA9IE5vbmUKICAgICAgICBzZWxmLmNsYXNzX3dlaWdodHMgPSBOb25lCiAgICAgICAgc2VsZi5lbmNvZGluZywgc2VsZi5yZXZlcnNlX2VuY29kaW5nID0gTm9uZSwgTm9uZQoKICAgIGRlZiBsb2FkX2RhdGEoc2VsZik6CiAgICAgICAgICAgICIiIkxvYWRzIHRoZSBmaWxlIGFuZCBwcmVwYXJlcyB0aGUgZGF0YXNldC4iIiIKICAgICAgICAgICAgbG9hZGVycyA9IHsKICAgICAgICAgICAgICAgICdjc3YnOiBwZC5yZWFkX2NzdiwKICAgICAgICAgICAgICAgICdnemlwJzogcGQucmVhZF9wYXJxdWV0LAogICAgICAgICAgICAgICAgJ2V4Y2VsJzogcGQucmVhZF9leGNlbCwKICAgICAgICAgICAgICAgICdqc29uJzogcGQucmVhZF9qc29uLAogICAgICAgICAgICAgICAgJ2ZlYXRoZXInOiBwZC5yZWFkX2ZlYXRoZXIsCiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICBpZiBzZWxmLmZpbGVfdHlwZSBub3QgaW4gbG9hZGVyczoKICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZiJVbnN1cHBvcnRlZCBmaWxlIHR5cGU6IHtzZWxmLmZpbGVfdHlwZX0iKQogICAgICAgICAgICBzZWxmLmRmID0gbG9hZGVyc1tzZWxmLmZpbGVfdHlwZV0oc2VsZi5maWxlX3BhdGgsICoqc2VsZi5rd2FyZ3MpLnJlc2V0X2luZGV4KCkKICAgIAogICAgICAgICAgICAjIExhYmVscyBzaG91bGQgc3RhcnQgZnJvbSAwOyB0aGV5IHdpbGwgYmUgbWFwcGVkIGJhY2sKICAgICAgICAgICAgIyB3aGVuIHNhdmluZyB0aGUgcHJlZGljdGVkIHJlc3VsdHMKICAgICAgICAgICAgaWYgc2VsZi5kZltzZWxmLmxhYmVsX2NvbHVtbl0ubWluKCkgPT0gMToKICAgICAgICAgICAgICAgIHNlbGYuZGZbc2VsZi5sYWJlbF9jb2x1bW5dIC09IDEKICAgIAogICAgICAgICAgICAjIE1hcCBsYWJlbHMgdG8gZGVuc2UgZm9yIENyb3NzRW50cm9weUwgKHRoZSBpdGFsaWFuIEJFUlQgZG9lc24ndCBsaWtlIHNwYXJzZSBhcnJheXMpCiAgICAgICAgICAgIHVuaXF1ZV9sYWJlbHMsIGxhYmVsX2NvdW50cyA9IG5wLnVuaXF1ZShzZWxmLmRmW3NlbGYubGFiZWxfY29sdW1uXSwgcmV0dXJuX2NvdW50cz1UcnVlKQogICAgICAgICAgICBzZWxmLm51bV9sYWJlbHMgPSBsZW4odW5pcXVlX2xhYmVscykKICAgICAgICAgICAgc2VsZi5lbmNvZGluZyA9IHtsYWJlbDppZHggZm9yIGlkeCxsYWJlbCBpbiBlbnVtZXJhdGUodW5pcXVlX2xhYmVscyl9CiAgICAgICAgICAgIHNlbGYucmV2ZXJzZV9lbmNvZGluZyA9IHtpZHg6bGFiZWwgZm9yIGlkeCxsYWJlbCBpbiBlbnVtZXJhdGUodW5pcXVlX2xhYmVscyl9CiAgICAgICAgICAgIHNlbGYuZGZbc2VsZi5sYWJlbF9jb2x1bW5dID0gc2VsZi5kZltzZWxmLmxhYmVsX2NvbHVtbl0ubWFwKHNlbGYuZW5jb2RpbmcpCiAgICAgICAgICAgICMgc2F2aW5nIHRoZSByZXZlcnNlIGluZGV4aW5nCiAgICAgICAgICAgIHdpdGggb3BlbigicmV2ZXJzZV9lbmNvZGluZy5qc29uIiwgInciKSBhcyBmOgogICAgICAgICAgICAgICAganNvbi5kdW1wKHNlbGYucmV2ZXJzZV9lbmNvZGluZywgZiwKICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRlbnQ9NCwgc29ydF9rZXlzPVRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgc2VwYXJhdG9ycz0oJywgJywgJzogJyksIGVuc3VyZV9hc2NpaT1GYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICBjbHM9TnVtcHlFbmNvZGVyKQogICAgCiAgICAgICAgICAgICMgQ2xhc3Mgd2VpZ2h0cwogICAgICAgICAgICBpbnZlcnNlID0gMSAvIGxhYmVsX2NvdW50cwogICAgICAgICAgICBub3JtYWxpemVkX3dlaWdodHMgPSBpbnZlcnNlIC8gaW52ZXJzZS5zdW0oKQogICAgICAgICAgICBwcmludChzZWxmLmRmLmhlYWQoKSkKICAgICAgICAgICAgIyBzZWxmLmNsYXNzX3dlaWdodHMgPSB0b3JjaC5GbG9hdFRlbnNvcihub3JtYWxpemVkX3dlaWdodHMpLnRvKCdjdWRhJykKCgogICAgZGVmIHN0cmF0aWZpZWRfc3BsaXQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgUGVyZm9ybXMgc3RyYXRpZmllZCB0cmFpbi92YWxpZGF0aW9uL3Rlc3Qgc3BsaXQuCiAgICAgICAgR2l2ZW4gdGhhdCB0aGUgZGF0YSBoYXMgbWFueSBsYWJlbHMgYW5kIHRoZXkgYXJlIG9mdGVuIHVuZXF1YWxseSBkaXN0cmlidXRlZCwKICAgICAgICBtYW55IGNsYXNzZXMgY2FuIGJlIG5vdCByZXByZXNlbnRlZCBhdCBhbGwgaW4gdGhlIHRyYWluaW5nIHNlc3Npb24uCiAgICAgICAgVGhpcyBtZXRob2QgZm9yY2VzIHNpbWlsYXIgY2xhc3MgZGlzdHJpYnV0aW9ucy4KICAgICAgICBJZiBzb21lIGNsYXNzZXMgYXJlIGluIGxlc3MgdGhhbiAzIG9ic2VydmF0aW9ucywgaXQgd2lsbCByYWlzZSBhbiBlcnJvci4KICAgICAgICAiIiIKICAgICAgICBpZiBzZWxmLmRmIGlzIE5vbmU6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIkRhdGEgbm90IGxvYWRlZC4gQ2FsbCBsb2FkX2RhdGEoKSBmaXJzdC4iKQoKICAgICAgICAjIEZpcnN0IHNwbGl0OiB0cmFpbit2YWwvdGVzdAogICAgICAgIHNwbGl0ID0gU3RyYXRpZmllZFNodWZmbGVTcGxpdChuX3NwbGl0cz0xLCB0ZXN0X3NpemU9c2VsZi50ZXN0X3NpemUsIHJhbmRvbV9zdGF0ZT1zZWxmLnJhbmRvbV9zdGF0ZSkKICAgICAgICB0cmFpbl92YWxfaWR4LCB0ZXN0X2lkeCA9IG5leHQoc3BsaXQuc3BsaXQoc2VsZi5kZiwgc2VsZi5kZltzZWxmLmxhYmVsX2NvbHVtbl0pKQogICAgICAgIHRyYWluX3ZhbF9kYXRhID0gc2VsZi5kZi5pbG9jW3RyYWluX3ZhbF9pZHhdLnJlc2V0X2luZGV4KGRyb3A9VHJ1ZSkKICAgICAgICB0ZXN0X3NldCA9IHNlbGYuZGYuaWxvY1t0ZXN0X2lkeF0ucmVzZXRfaW5kZXgoZHJvcD1UcnVlKQoKICAgICAgICAjIFNlY29uZCBzcGxpdDogdHJhaW4vdmFsaWRhdGlvbgogICAgICAgIHNwbGl0ID0gU3RyYXRpZmllZFNodWZmbGVTcGxpdChuX3NwbGl0cz0xLCB0ZXN0X3NpemU9c2VsZi52YWxfc2l6ZSwgcmFuZG9tX3N0YXRlPXNlbGYucmFuZG9tX3N0YXRlKQogICAgICAgIHRyYWluX2lkeCwgdmFsX2lkeCA9IG5leHQoc3BsaXQuc3BsaXQodHJhaW5fdmFsX2RhdGEsIHRyYWluX3ZhbF9kYXRhW3NlbGYubGFiZWxfY29sdW1uXSkpCiAgICAgICAgdHJhaW5fc2V0ID0gdHJhaW5fdmFsX2RhdGEuaWxvY1t0cmFpbl9pZHhdLnJlc2V0X2luZGV4KGRyb3A9VHJ1ZSkKICAgICAgICB2YWxfc2V0ID0gdHJhaW5fdmFsX2RhdGEuaWxvY1t2YWxfaWR4XS5yZXNldF9pbmRleChkcm9wPVRydWUpCgogICAgICAgICMgQ29udmVydCB0byBIdWdnaW5nIEZhY2UgRGF0YXNldERpY3QKICAgICAgICBzZWxmLmRhdGFzZXQgPSBEYXRhc2V0RGljdCh7CiAgICAgICAgICAgICd0cmFpbic6IERhdGFzZXQuZnJvbV9wYW5kYXModHJhaW5fc2V0KSwKICAgICAgICAgICAgJ3ZhbGlkYXRpb24nOiBEYXRhc2V0LmZyb21fcGFuZGFzKHZhbF9zZXQpLAogICAgICAgICAgICAndGVzdCc6IERhdGFzZXQuZnJvbV9wYW5kYXModGVzdF9zZXQpCiAgICAgICAgfSkKCiAgICBkZWYgZ2V0X2RhdGFzZXQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgUmV0cmlldmVzIHRoZSBkYXRhc2V0IGRpY3Rpb25hcnkgY29udGFpbmluZyB0cmFpbiwgdmFsaWRhdGlvbiwgYW5kIHRlc3Qgc2V0cy4KCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGF0YXNldERpY3Q6IEEgZGljdGlvbmFyeSBjb250YWluaW5nIHRoZSBzcGxpdHMgYXMgSHVnZ2luZyBGYWNlIGRhdGFzZXRzLgogICAgICAgICIiIgogICAgICAgIGlmIHNlbGYuZGF0YXNldCBpcyBOb25lOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJEYXRhc2V0IG5vdCBjcmVhdGVkLiBDYWxsIHN0cmF0aWZpZWRfc3BsaXQoKSBmaXJzdC4iKQogICAgICAgIHJldHVybiBzZWxmLmRhdGFzZXQKCiAgICBkZWYgZ2V0X2NsYXNzX3dlaWdodHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgUmV0cmlldmVzIHRoZSBjbGFzcyB3ZWlnaHRzLgoKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICB0b3JjaC5GbG9hdFRlbnNvcjogQ2xhc3Mgd2VpZ2h0cyBmb3IgaGFuZGxpbmcgaW1iYWxhbmNlZCBjbGFzc2VzLgogICAgICAgICIiIgogICAgICAgIGlmIHNlbGYuY2xhc3Nfd2VpZ2h0cyBpcyBOb25lOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJDbGFzcyB3ZWlnaHRzIG5vdCBjb21wdXRlZC4gQ2FsbCBsb2FkX2RhdGEoKSBmaXJzdC4iKQogICAgICAgIHJldHVybiBzZWxmLmNsYXNzX3dlaWdodHMKCiAgICBkZWYgZ2V0X251bV9sYWJlbHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgUmV0cmlldmVzIHRoZSBudW1iZXIgb2YgdW5pcXVlIGxhYmVscy4KCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgaW50OiBOdW1iZXIgb2YgdW5pcXVlIGxhYmVscyBpbiB0aGUgZGF0YXNldC4KICAgICAgICAiIiIKICAgICAgICBpZiBzZWxmLm51bV9sYWJlbHMgaXMgTm9uZToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiTnVtYmVyIG9mIGxhYmVscyBub3QgYXZhaWxhYmxlLiBDYWxsIGxvYWRfZGF0YSgpIGZpcnN0LiIpCiAgICAgICAgcmV0dXJuIHNlbGYubnVtX2xhYmVscwoKICAgIGRlZiBnZXRfZW5jb2Rpbmcoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgUmV0cmlldmVzIHRoZSBtYXBwaW5nIG9mIGxhYmVscyB0byBjYXRlZ29yaWVzLgoKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBkaWN0OiBNYXBwaW5nIG9mIGxhYmVsIElEcyB0byB0aGVpciByZXNwZWN0aXZlIGNhdGVnb3JpZXMuCiAgICAgICAgIiIiCiAgICAgICAgaWYgc2VsZi5lbmNvZGluZyBpcyBOb25lOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJMYWJlbCBtYXBwaW5nIG5vbmV4aXN0ZW50LiBDYWxsIGxvYWRfZGF0YSgpIGZpcnN0LiIpCiAgICAgICAgcmV0dXJuIHNlbGYuZW5jb2RpbmcKCiAgICBkZWYgZ2V0X3JfZW5jb2Rpbmcoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgUmV0cmlldmVzIHRoZSBtYXBwaW5nIG9mIGxhYmVscyB0byBjYXRlZ29yaWVzLgoKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBkaWN0OiBNYXBwaW5nIG9mIGxhYmVsIElEcyB0byB0aGVpciByZXNwZWN0aXZlIGNhdGVnb3JpZXMuCiAgICAgICAgIiIiCiAgICAgICAgaWYgc2VsZi5yZXZlcnNlX2VuY29kaW5nIGlzIE5vbmU6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIkxhYmVsIG1hcHBpbmcgbm9uZXhpc3RlbnQuIENhbGwgbG9hZF9kYXRhKCkgZmlyc3QuIikKICAgICAgICByZXR1cm4gc2VsZi5yZXZlcnNlX2VuY29kaW5nCgoKZnJvbSB0cmFuc2Zvcm1lcnMgaW1wb3J0IEF1dG9Ub2tlbml6ZXIKCmNsYXNzIFRva2VuaXplckZ1bmN0aW9uOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG1vZGVsX25hbWUsIG1heF9sZW5ndGg9NTEyLCB1c2VfZmFzdD1UcnVlLCB1c2VfY2FjaGU9RmFsc2UpOgogICAgICAgICIiIgogICAgICAgIEluaXRpYWxpemUgdGhlIHRva2VuaXplciBmdW5jdGlvbiB3cmFwcGVyIPCfjK8KICAgICAgICBBcmdzOgogICAgICAgICAgICBtb2RlbF9uYW1lIChzdHIpOiBOYW1lIG9mIHRoZSBwcmUtdHJhaW5lZCBtb2RlbC4KICAgICAgICAgICAgbWF4X2xlbmd0aCAoaW50KTogTWF4aW11bSBzZXF1ZW5jZSBsZW5ndGggZm9yIHRva2VuaXphdGlvbi4KICAgICAgICAgICAgdXNlX2Zhc3QgKGJvb2wpOiBXaGV0aGVyIHRvIHVzZSB0aGUgZmFzdCB0b2tlbml6ZXIgaW1wbGVtZW50YXRpb24uCiAgICAgICAgICAgIHVzZV9jYWNoZSAoYm9vbCk6IFdoZXRoZXIgdG8gY2FjaGUgdGhlIHRva2VuaXplciByZXN1bHRzLgogICAgICAgICIiIgogICAgICAgIHNlbGYudG9rZW5pemVyID0gQXV0b1Rva2VuaXplci5mcm9tX3ByZXRyYWluZWQobW9kZWxfbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VfZmFzdD11c2VfZmFzdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VfY2FjaGU9dXNlX2NhY2hlKQogICAgICAgIHNlbGYubWF4X2xlbmd0aCA9IG1heF9sZW5ndGgKCiAgICBkZWYgX19jYWxsX18oc2VsZiwgZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgVG9rZW5pemVzIHRoZSBpbnB1dCBkYXRhLgoKICAgICAgICBBcmdzOgogICAgICAgICAgICBkYXRhIChkaWN0KTogQSBkaWN0aW9uYXJ5IGNvbnRhaW5pbmcgdGhlICd0ZXh0JyBmaWVsZCB0byB0b2tlbml6ZS4KCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgZGljdDogVG9rZW5pemVkIGRhdGEgaW5jbHVkaW5nIGlucHV0IElEcywgYXR0ZW50aW9uIG1hc2tzLCBldGMuCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYudG9rZW5pemVyKGRhdGFbJ3RleHQnXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZz0nbWF4X2xlbmd0aCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRydW5jYXRpb249VHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4X2xlbmd0aD1zZWxmLm1heF9sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybl90ZW5zb3JzPSJwdCIpCgogICAgZGVmIGdldF90b2tlbml6ZXIoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYudG9rZW5pemVyCgoKCmltcG9ydCB0b3JjaApmcm9tIHRvcmNoIGltcG9ydCBubgpmcm9tIHRvcmNoLnV0aWxzLmRhdGEgaW1wb3J0IERhdGFMb2FkZXIKZnJvbSB0b3JjaC5vcHRpbSBpbXBvcnQgQWRhbVcKZnJvbSB0b3JjaG1ldHJpY3MuY2xhc3NpZmljYXRpb24gaW1wb3J0IE11bHRpY2xhc3NGMVNjb3JlLCBBY2N1cmFjeQoKZnJvbSB0cmFuc2Zvcm1lcnMgaW1wb3J0IEF1dG9Nb2RlbEZvclNlcXVlbmNlQ2xhc3NpZmljYXRpb24sIEF1dG9Nb2RlbApmcm9tIHRyYW5zZm9ybWVycyBpbXBvcnQgUHJlVHJhaW5lZE1vZGVsCmZyb20gdHJhbnNmb3JtZXJzLm1vZGVsaW5nX291dHB1dHMgaW1wb3J0IFNlcXVlbmNlQ2xhc3NpZmllck91dHB1dApmcm9tIHRyYW5zZm9ybWVycyBpbXBvcnQgQXV0b0NvbmZpZywgVHJhaW5pbmdBcmd1bWVudHMsIEVhcmx5U3RvcHBpbmdDYWxsYmFjaywgVHJhaW5lcgoKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZSwgZGF0ZXRpbWUKaW1wb3J0IG9zCgppbXBvcnQganNvbgojIGltcG9ydCB3YW5kYgoKY2xhc3MgQmVydEZvclNlbnRlbmNlQ2xhc3NpZmljYXRpb24oUHJlVHJhaW5lZE1vZGVsKToKCiAgICAiIiIKICAgIEJFUlQgYXJjaGl0ZWN0dXJlIGlzIGludGVuZGVkIHRvIGJlIGZyb20gImRibWR6L2JlcnQtYmFzZS1pdGFsaWFuLXh4bC1jYXNlZCIKICAgIGJ1dCBvdGhlciBtb2RlbHMgY2FuIGJlIHRyaWVkLgogICAgIiIiCgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb25maWcsIG1vZGVsX25hbWUsIG51bV9sYWJlbHMsIGNsYXNzX3dlaWdodHM9Tm9uZSk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXyhjb25maWcpCiAgICAgICAgc2VsZi5udW1fbGFiZWxzID0gbnVtX2xhYmVscwogICAgICAgIHNlbGYuYmVydCA9IEF1dG9Nb2RlbC5mcm9tX3ByZXRyYWluZWQobW9kZWxfbmFtZSkKICAgICAgICBzZWxmLmNsYXNzaWZpZXIgPSBubi5MaW5lYXIoc2VsZi5iZXJ0LmNvbmZpZy5oaWRkZW5fc2l6ZSwgbnVtX2xhYmVscykKICAgICAgICBzZWxmLmNsYXNzX3dlaWdodHMgPSBjbGFzc193ZWlnaHRzCiAgICAgICAgc2VsZi5hY2N1cmFjeSA9IEFjY3VyYWN5KG51bV9jbGFzc2VzPW51bV9sYWJlbHMsIHRhc2s9J211bHRpY2xhc3MnKQogICAgICAgIHNlbGYuZjEgPSBNdWx0aWNsYXNzRjFTY29yZShudW1fY2xhc3Nlcz1udW1fbGFiZWxzLCBhdmVyYWdlPSdtYWNybycpICMgY2hhbmdlZCB3ZWlnaHQsbWljcm8gTm9uZSwg4oCYYmluYXJ54oCZIChkZWZhdWx0KSwg4oCYbWljcm/igJksIOKAmG1hY3Jv4oCZLCDigJhzYW1wbGVz4oCZLCDigJh3ZWlnaHRlZOKAmV0KCiAgICBkZWYgZm9yd2FyZChzZWxmLCBpbnB1dF9pZHMsIGF0dGVudGlvbl9tYXNrPU5vbmUsIGxhYmVscz1Ob25lKToKICAgICAgICBvdXRwdXRzID0gc2VsZi5iZXJ0KGlucHV0X2lkcz1pbnB1dF9pZHMsIGF0dGVudGlvbl9tYXNrPWF0dGVudGlvbl9tYXNrKQogICAgICAgIGxvZ2l0cyA9IHNlbGYuY2xhc3NpZmllcihvdXRwdXRzLmxhc3RfaGlkZGVuX3N0YXRlWzosIDAsIDpdKQoKICAgICAgICBsb3NzID0gTm9uZQogICAgICAgIGlmIGxhYmVscyBpcyBub3QgTm9uZToKCiAgICAgICAgICAgIGxvc3NfZmN0ID0gbm4uQ3Jvc3NFbnRyb3B5TG9zcyhsYWJlbF9zbW9vdGhpbmc9MC4xKSAjLHdlaWdodD1zZWxmLmNsYXNzX3dlaWdodHMKICAgICAgICAgICAgbG9zcyA9IGxvc3NfZmN0KGxvZ2l0cywgbGFiZWxzKQoKICAgICAgICAgICAgZjFfc2NvcmUgPSBzZWxmLmYxKGxvZ2l0cy5hcmdtYXgoZGltPTEpLCBsYWJlbHMpCiAgICAgICAgICAgIGFjY3VyYWN5X3Njb3JlID0gc2VsZi5hY2N1cmFjeShsb2dpdHMuYXJnbWF4KGRpbT0xKSwgbGFiZWxzKQogICAgIAogICAgICAgIHJldHVybiBTZXF1ZW5jZUNsYXNzaWZpZXJPdXRwdXQobG9zcz1sb3NzLCBsb2dpdHM9bG9naXRzKQoKY2xhc3MgVHJhaW5lckhhbmRsZXI6CiAgICBkZWYgX19pbml0X18oc2VsZiwgdHJhaW5lciwgdG9rZW5pemVkX2RhdGFzZXRzLCBudW1fbGFiZWxzLCBlbmNvZGluZywgbW9kZWxfbmFtZSwKICAgICAgICAgICAgICAgICBtb2RlbF9zYXZlX3BhdGgpOgogICAgICAgICIiIgogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRyYWluZXI6IEh1Z2dpbmcgRmFjZSBUcmFpbmVyIGluc3RhbmNlLgogICAgICAgICAgICB0b2tlbml6ZWRfZGF0YXNldHM6IERhdGFzZXREaWN0IHdpdGggdHJhaW4vdmFsL3Rlc3Qgc3BsaXRzLgogICAgICAgICAgICBudW1fbGFiZWxzOiBOdW1iZXIgb2YgbGFiZWxzIGluIHRoZSBjbGFzc2lmaWNhdGlvbiB0YXNrLgogICAgICAgICAgICBlbmNvZGluZzogTWFwcGluZyBmcm9tIGRlbnNlIHRvIHNwYXJzZSBvcmlnaW5hbCBsYWJlbGxpbmcuCiAgICAgICAgICAgIG1vZGVsX25hbWUKICAgICAgICAgICAgbW9kZWxfc2F2ZV9wYXRoOiBQYXRoIHRvIHNhdmUgdGhlIGNvbmZpZ3VyYXRpb24sIHdlaWdodHMgYW5kIHRva2VuaXplciBmb3IgcmVwcm9kdWNpYmlsaXR5LgogICAgICAgICIiIgogICAgICAgIHNlbGYudHJhaW5lciA9IHRyYWluZXIKICAgICAgICBzZWxmLnRva2VuaXplZF9kYXRhc2V0cyA9IHRva2VuaXplZF9kYXRhc2V0cwogICAgICAgIHNlbGYubnVtX2xhYmVscyA9IG51bV9sYWJlbHMKICAgICAgICBzZWxmLmVuY29kaW5nID0gZW5jb2RpbmcKICAgICAgICBzZWxmLm1vZGVsX25hbWUgPSBtb2RlbF9uYW1lCiAgICAgICAgc2VsZi5tb2RlbF9zYXZlX3BhdGggPSBtb2RlbF9zYXZlX3BhdGgKCiAgICBkZWYgY29tcHV0ZV9mMV9zY29yZShzZWxmLCBwcmVkaWN0aW9ucyk6CiAgICAgICAgIiIiCiAgICAgICAgTWljcm8gRjEgc2NvcmUgZnJvbQoKICAgICAgICBBcmdzOgogICAgICAgICAgICBwcmVkaWN0aW9uczogT3V0cHV0IGZyb20gdGhlIHRyYWluZXIucHJlZGljdCgpIG1ldGhvZC4KCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgZjFfc2NvcmU6IFRoZSBjYWxjdWxhdGVkIEYxIHNjb3JlLgogICAgICAgICIiIgogICAgICAgIGxvZ2l0cyA9IHRvcmNoLnRlbnNvcihwcmVkaWN0aW9ucy5wcmVkaWN0aW9ucykKICAgICAgICBsYWJlbHMgPSB0b3JjaC50ZW5zb3IocHJlZGljdGlvbnMubGFiZWxfaWRzKQogICAgICAgIGYxID0gTXVsdGljbGFzc0YxU2NvcmUobnVtX2NsYXNzZXM9c2VsZi5udW1fbGFiZWxzLCBhdmVyYWdlPSdtaWNybycpICMgd2VpZ2h0CiAgICAgICAgZjFfc2NvcmUgPSBmMShsb2dpdHMuYXJnbWF4KGRpbT0xKSwgbGFiZWxzLmZsb2F0KCkpCiAgICAgICAgcmV0dXJuIGYxX3Njb3JlLCBsb2dpdHMsIGxhYmVscwoKICAgIGRlZiBzYXZlX2YxX3Jlc3VsdHMoc2VsZiwgZjFfc2NvcmUpOgogICAgICAgICIiIgogICAgICAgIFNhdmUgdGhlIEYxIHNjb3JlIHRvIGEgQ1NWIGZpbGUuCgogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGYxX3Njb3JlOiBieSBkZWZhdWx0LCBpdCdzIHRoZSBtaWNybyBGMSB3ZWlnaHRlZCBvbiBjbGFzcyBmcmVxdWVuY3kuCiAgICAgICAgIiIiCiAgICAgICAgbm93ID0gZGF0ZXRpbWUudG9kYXkoKQogICAgICAgIAogICAgICAgIGNzdkZpbGUgPSBzZWxmLm1vZGVsX3NhdmVfcGF0aCArICcvJyArICBmJ3tzZWxmLm1vZGVsX25hbWV9LmNzdic7CgogICAgICAgIGRmID0gcGQuRGF0YUZyYW1lKHsKICAgICAgICAgICAgJ0YxJzogW2YxX3Njb3JlLml0ZW0oKV0sCiAgICAgICAgICAgICdtb2RlbGxvJzogW3NlbGYubW9kZWxfbmFtZV0sCiAgICAgICAgICAgICdUJzogW25vd10sCiAgICAgICAgfSkKICAgICAgICAKICAgICAgICBpZiBub3Qgb3MucGF0aC5pc2ZpbGUoY3N2RmlsZSk6CiAgICAgICAgICAgIGRmLnRvX2Nzdihjc3ZGaWxlLCBoZWFkZXI9J2NvbHVtbl9uYW1lcycsIGluZGV4PUZhbHNlKQogICAgICAgIGVsc2U6ICAjIGVsc2UgaXQgZXhpc3RzIHNvIGFwcGVuZCB3aXRob3V0IHdyaXRpbmcgdGhlIGhlYWRlcgogICAgICAgICAgICBkZi50b19jc3YoY3N2RmlsZSwgbW9kZT0nYScsIGhlYWRlcj1GYWxzZSwgaW5kZXg9RmFsc2UpICAgICAgICAKICAgICAgICAKICAgICAgICBwcmludChmIkYxIHNjb3JlIHNhdmVkIHRvIHtzZWxmLm1vZGVsX25hbWV9LmNzdiIpCgogICAgZGVmIHNhdmVfcHJlZGljdGlvbnMoc2VsZiwgbG9naXRzLCBsYWJlbHMpOgogICAgICAgICIiIgogICAgICAgIFNhdmUgcHJlZGljdGVkIGFuZCB0cnVlIGxhYmVscyB0byBhIENTViBmaWxlLgoKICAgICAgICBBcmdzOgogICAgICAgICAgICBsb2dpdHM6IE1vZGVsIGxvZ2l0cyBmcm9tIHRoZSBwcmVkaWN0aW9ucy4KICAgICAgICAgICAgbGFiZWxzOiBHcm91bmQgdHJ1dGggbGFiZWwgaW5kZXhlcyBmcm9tIHRoZSBwcmVkaWN0aW9ucy4KICAgICAgICAiIiIKICAgICAgICBub3cgPSBkYXRldGltZS50b2RheSgpCiAgICAgICAgaW52ZXJ0ZWRfZW5jb2RpbmcgPSB7aW50KHYpOiBrIGZvciBrLCB2IGluIHNlbGYuZW5jb2RpbmcuaXRlbXMoKX0KICAgICAgICBwcmVkaWN0ZWRfaW5kaWNlcyA9IGxvZ2l0cy5hcmdtYXgoZGltPTEpCiAgICAgICAgcHJlZGljdGVkX2xhYmVscyA9IFtpbnZlcnRlZF9lbmNvZGluZ1tpZHguaXRlbSgpXSBmb3IgaWR4IGluIHByZWRpY3RlZF9pbmRpY2VzXQogICAgICAgIHRydWVfbGFiZWxzID0gW2ludmVydGVkX2VuY29kaW5nW2lkeC5pdGVtKCldIGZvciBpZHggaW4gbGFiZWxzXQoKICAgICAgICBvcmlnaW5hbF9pbmRleCA9IHNlbGYudG9rZW5pemVkX2RhdGFzZXRzWyd0ZXN0J11bJ2luZGV4J10gI29yaWdpbmFsIGluZGV4ZXMgZm9yIHRlc3Qgb2JzZXJ2YXRpb25zIGluIHRoZSBpbnB1dCBkZgoKICAgICAgICByZXN1bHRzID0gcGQuRGF0YUZyYW1lKHsKICAgICAgICAgICAgJ29yaWdpbmFsX2luZGV4Jzogb3JpZ2luYWxfaW5kZXgsCiAgICAgICAgICAgICd0cnVlX2xhYmVsJzogdHJ1ZV9sYWJlbHMsCiAgICAgICAgICAgICdwcmVkaWN0ZWRfbGFiZWwnOiBwcmVkaWN0ZWRfbGFiZWxzLAogICAgICAgIH0pCgogICAgICAgIHJlc3VsdHMudHJ1ZV9sYWJlbCwgcmVzdWx0cy5wcmVkaWN0ZWRfbGFiZWwgPSByZXN1bHRzLnRydWVfbGFiZWwgKyAxLCByZXN1bHRzLnByZWRpY3RlZF9sYWJlbCArIDEKCiAgICAgICAgZmlsZV9uYW1lID0gZid7c2VsZi5tb2RlbF9uYW1lfV97bm93Lm1vbnRofV97bm93LmRheX0te25vdy5ob3VyfV97bm93Lm1pbnV0ZX0uY3N2JwogICAgICAgIHJlc3VsdHMudG9fY3N2KHNlbGYubW9kZWxfc2F2ZV9wYXRoICsgJy8nICsgZmlsZV9uYW1lLCBpbmRleD1GYWxzZSkKICAgICAgICBwcmludChmIlByZWRpY3Rpb25zIHNhdmVkIHRvIHtmaWxlX25hbWV9IikKCiAgICBkZWYgc2F2ZV9tb2RlbF9hbmRfdG9rZW5pemVyKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFNhdmUgdGhlIHRyYWluZWQgbW9kZWwgYW5kIHRva2VuaXplciB0byB0aGUgc3BlY2lmaWVkIHBhdGguCiAgICAgICAgIiIiCiAgICAgICAgcHJpbnQoZiJTYXZpbmcgdGhlIHRyYWluZWQgbW9kZWwgYXMge3NlbGYubW9kZWxfbmFtZX0uLi4iKQogICAgICAgIHNlbGYudHJhaW5lci5tb2RlbC5zYXZlX3ByZXRyYWluZWQoc2VsZi5tb2RlbF9zYXZlX3BhdGgpCiAgICAgICAgc2VsZi50cmFpbmVyLnRva2VuaXplci5zYXZlX3ByZXRyYWluZWQoc2VsZi5tb2RlbF9zYXZlX3BhdGgpCiAgICAgICAgcHJpbnQoZiJNb2RlbCBhbmQgdG9rZW5pemVyIHNhdmVkIHRvIHtzZWxmLm1vZGVsX3NhdmVfcGF0aH0iKQoKICAgIGRlZiBydW4oc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgRXhlY3V0ZSB0aGUgdHJhaW5pbmcgYW5kIHNhdmUgdGhlIG91dHB1dHMuCiAgICAgICAgIiIiCiAgICAgICAgcHJpbnQoIlN0YXJ0aW5nIHRyYWluaW5nLi4uIikKICAgICAgICAjc2VsZi50cmFpbmVyLnRyYWluKHJlc3VtZV9mcm9tX2NoZWNrcG9pbnQ9VHJ1ZSkKICAgICAgICBzZWxmLnRyYWluZXIudHJhaW4oKQogICAgICAgIHNlbGYudHJhaW5lci5zYXZlX3N0YXRlKCkKCiAgICAgICAgcHJpbnQoIkV2YWx1YXRpbmcgdGVzdCBzZXQuLi4iKQogICAgICAgIHByZWRpY3Rpb25zID0gc2VsZi50cmFpbmVyLnByZWRpY3Qoc2VsZi50b2tlbml6ZWRfZGF0YXNldHNbJ3Rlc3QnXSkKCiAgICAgICAgZjFfc2NvcmUsIGxvZ2l0cywgbGFiZWxzID0gc2VsZi5jb21wdXRlX2YxX3Njb3JlKHByZWRpY3Rpb25zKQogICAgICAgIHByaW50KGYiRjEgc2NvcmU6IHtmMV9zY29yZS5pdGVtKCl9XG4iKQoKICAgICAgICBzZWxmLnNhdmVfZjFfcmVzdWx0cyhmMV9zY29yZSkKICAgICAgICBzZWxmLnNhdmVfcHJlZGljdGlvbnMobG9naXRzLCBsYWJlbHMpCiAgICAgICAgc2VsZi5zYXZlX21vZGVsX2FuZF90b2tlbml6ZXIoKQogICAgICAgIHByaW50KCJEb25lLiIpCgoKICAgIApmaWxlX2Jhc2VwYXRoID0gIi9sb2NhbC1kYXRhIgoKaW1wb3J0IGV2YWx1YXRlCmRlZiBjb21wdXRlX21ldHJpY3MoZXZhbF9wcmVkKToKICAgIG1ldHJpY3MgPSBbImYxIiwiYWNjdXJhY3kiLCAicmVjYWxsIiwgInByZWNpc2lvbiJdICNMaXN0IG9mIG1ldHJpY3MgdG8gcmV0dXJuICwKICAgIG1ldHJpYz17fQogICAgZm9yIG1ldCBpbiBtZXRyaWNzOgogICAgICAgIG1ldHJpY1ttZXRdID0gZXZhbHVhdGUubG9hZChtZXQpI2xvYWRfbWV0cmljKG1ldCkKICAgIGxvZ2l0cywgbGFiZWxzID0gZXZhbF9wcmVkCiAgICBwcmVkaWN0aW9ucyA9IG5wLmFyZ21heChsb2dpdHMsIGF4aXM9LTEpCiAgICBtZXRyaWNfcmVzPXt9CiAgICBmb3IgbWV0IGluIG1ldHJpY3M6CiAgICAgICAgaWYgKG1ldCAhPSAnYWNjdXJhY3knKToKICAgICAgICAgICAgbWV0cmljX3Jlc1ttZXRdPW1ldHJpY1ttZXRdLmNvbXB1dGUocHJlZGljdGlvbnM9cHJlZGljdGlvbnMsIHJlZmVyZW5jZXM9bGFiZWxzLCBhdmVyYWdlPSdtYWNybycpW21ldF0KICAgICAgICBlbHNlOgogICAgICAgICAgICBtZXRyaWNfcmVzW21ldF09bWV0cmljW21ldF0uY29tcHV0ZShwcmVkaWN0aW9ucz1wcmVkaWN0aW9ucywgcmVmZXJlbmNlcz1sYWJlbHMpW21ldF0KICAgICAgICAgICAgCiAgICBkYXRhX2ZpbGVuYW1lID0gJ3RyYWluX21ldHJpY3MuY3N2JwogICAgcm93ID0gcGQuRGF0YUZyYW1lKHtrOiBbdl0gZm9yIGssIHYgaW4gbWV0cmljX3Jlcy5pdGVtcygpfSkKICAgIAogICAgZGF0YWZyYW1lX2FwcGVuZChkaXJlY3Rvcnk9bW9kZWxfZGlyLCBkYXRhX2ZpbGVuYW1lPWRhdGFfZmlsZW5hbWUsIHJvdz1yb3cpCgogICAgcmV0dXJuIG1ldHJpY19yZXMKCmRlZiBkYXRhZnJhbWVfYXBwZW5kKGRpcmVjdG9yeSwgZGF0YV9maWxlbmFtZSwgcm93KToKICAgICMgbW9kdWxlIGZvciB1c2UgaW4gZGlmZmVyZW50IHN0YWdlcyBvZiB0cmFpbmluZyBhbmQgdGVzdGluZwogICAgaWYgbm90IHBhdGguZXhpc3RzKG1vZGVsX2Rpcik6CiAgICAgICAgbWFrZWRpcnMobW9kZWxfZGlyKQogICAgRk4gPSBkaXJlY3RvcnkgKyAnLycgKyBkYXRhX2ZpbGVuYW1lCgogICAgaWYgbm90IChwYXRoLmV4aXN0cyhGTikpOgogICAgICAgIHJvdy50b19jc3YoRk4sIGluZGV4PUZhbHNlLCBoZWFkZXI9VHJ1ZSkKICAgIGVsc2U6CiAgICAgICAgcm93LnRvX2NzdihGTiwgbW9kZT0nYScsIGluZGV4PUZhbHNlLCBoZWFkZXI9RmFsc2UpCiAgICAKZGVmIHRyYWluKHByb2plY3QsICAgICAgICAgIAogICAgICAgICAgdGFyZ2V0X21vZGVsX25hbWU9IiIsCiAgICAgICAgICBudW1fdHJhaW5fZXBvY2hzPTMsCiAgICAgICAgICBwZXJfZGV2aWNlX3RyYWluX2JhdGNoX3NpemU9MTYsCiAgICAgICAgICBwZXJfZGV2aWNlX2V2YWxfYmF0Y2hfc2l6ZT0xNiwKICAgICAgICAgIGdyYWRpZW50X2FjY3VtdWxhdGlvbl9zdGVwcz0yLAogICAgICAgICAgd2VpZ2h0X2RlY2F5PTAuMDA1LAogICAgICAgICAgbGVhcm5pbmdfcmF0ZT0xZS01LAogICAgICAgICAgbHJfc2NoZWR1bGVyX3R5cGU9J2xpbmVhcicpOgoKICAgIGdsb2JhbCBtb2RlbF9kaXIKICAgIG1vZGVsX2RpciA9IGYie2ZpbGVfYmFzZXBhdGh9L21vZGVsIgogICAgZGF0YV9kaXIgPSBmIntmaWxlX2Jhc2VwYXRofS9kYXRhIgogICAgbG9nZ2luZ19kaXIgPSBmIntmaWxlX2Jhc2VwYXRofS9sb2dnaW5nIgogICAgb3V0cHV0X2RpciA9IGYie2ZpbGVfYmFzZXBhdGh9L3R1bmVkX21vZGVsIgogICAgCiAgICB0cnk6CiAgICAgICAgc2h1dGlsLnJtdHJlZShkYXRhX2RpcikKICAgIGV4Y2VwdDoKICAgICAgICBwcmludCgiRXJyb3IgZGVsZXRpbmcgZGF0YSBkaXIiKQogICAgICAgICAgICAgICAgCiAgICAjIENyZWF0ZSB0aGUgZGlyZWN0b3J5IGZvciB0aGUgZGF0YQogICAgaWYgbm90IHBhdGguZXhpc3RzKGRhdGFfZGlyKToKICAgICAgICBtYWtlZGlycyhkYXRhX2RpcikKCiAgICB0cnk6CiAgICAgICAgc2h1dGlsLnJtdHJlZShtb2RlbF9kaXIpCiAgICBleGNlcHQ6CiAgICAgICAgcHJpbnQoIkVycm9yIGRlbGV0aW5nIG1vZGVsIGRpciIpCiAgICAgICAgCiAgICAgIyBDcmVhdGUgdGhlIGRpcmVjdG9yeSBmb3IgdGhlIG1vZGVsCiAgICBpZiBub3QgcGF0aC5leGlzdHMobW9kZWxfZGlyKToKICAgICAgICBtYWtlZGlycyhtb2RlbF9kaXIpCiAgICBpZiBub3QgcGF0aC5leGlzdHMobG9nZ2luZ19kaXIpOgogICAgICAgIG1ha2VkaXJzKGxvZ2dpbmdfZGlyKSAgICAKICAgIGlmIG5vdCBwYXRoLmV4aXN0cyhvdXRwdXRfZGlyKToKICAgICAgICBtYWtlZGlycyhvdXRwdXRfZGlyKQoKICAgIG1vZGVsX3BhcmFtcyA9IHsKICAgICAgICAibnVtX3RyYWluX2Vwb2NocyI6IG51bV90cmFpbl9lcG9jaHMsCiAgICAgICAgInBlcl9kZXZpY2VfdHJhaW5fYmF0Y2hfc2l6ZSI6IHBlcl9kZXZpY2VfdHJhaW5fYmF0Y2hfc2l6ZSwKICAgICAgICAicGVyX2RldmljZV9ldmFsX2JhdGNoX3NpemUiOiBwZXJfZGV2aWNlX2V2YWxfYmF0Y2hfc2l6ZSwKICAgICAgICAiZ3JhZGllbnRfYWNjdW11bGF0aW9uX3N0ZXBzIjogZ3JhZGllbnRfYWNjdW11bGF0aW9uX3N0ZXBzLAogICAgICAgICJ3ZWlnaHRfZGVjYXkiOiB3ZWlnaHRfZGVjYXksCiAgICAgICAgImxlYXJuaW5nX3JhdGUiOiBsZWFybmluZ19yYXRlLAogICAgICAgICJscl9zY2hlZHVsZXJfdHlwZSI6IGxyX3NjaGVkdWxlcl90eXBlCiAgICB9CgogICAgVVJMPSdodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vdG4tYWl4cGEvZG9jdW1lbnQtY2xhc3NpZmllci9yZWZzL2hlYWRzL21haW4vc3JjL3RyYWluX2RhdGEuY3N2JwogICAgZGF0YSA9IHBkLnJlYWRfY3N2KFVSTCkKICAgIGRhdGEgPSBkYXRhLmxvY1s6LCB+ZGF0YS5jb2x1bW5zLnN0ci5jb250YWlucygnXlVubmFtZWQnKV0KICAgIGZpbGVfaW5wdXQgPSBkYXRhLnRvX2NzdihmJ3tkYXRhX2Rpcn0vZGF0YS5jc3YnLCBlbmNvZGluZz0nVVRGLTgnLCBpbmRleD1GYWxzZSkgICAgICAgICAgCiAgICBwcmludChmaWxlX2lucHV0KQogICAgICAgICAgICAgIAogICAgbW9kZWxfbmFtZSA9ICJkYm1kei9iZXJ0LWJhc2UtaXRhbGlhbi14eGwtY2FzZWQiCiAgICAKICAgIGRhdGFsb2FkZXIgPSBEYXRhbG9hZGVyKGZpbGVfcGF0aD1mJ3tkYXRhX2Rpcn0vZGF0YS5jc3YnKQogICAgZGF0YWxvYWRlci5sb2FkX2RhdGEoKQogICAgZGF0YWxvYWRlci5zdHJhdGlmaWVkX3NwbGl0KCkKICAgIGRhdGFzZXQgPSBkYXRhbG9hZGVyLmdldF9kYXRhc2V0KCkKICAgIG51bV9sYWJlbHMgPSBkYXRhbG9hZGVyLmdldF9udW1fbGFiZWxzKCkKICAgIGVuY29kaW5nID0gZGF0YWxvYWRlci5nZXRfZW5jb2RpbmcoKQogICAgCiAgICB0b2tlbml6ZV9mdW5jdGlvbiA9IFRva2VuaXplckZ1bmN0aW9uKG1vZGVsX25hbWU9bW9kZWxfbmFtZSwgbWF4X2xlbmd0aD01MTIpCiAgICB0b2tlbml6ZWRfZGF0YXNldHMgPSAoZGF0YXNldC5tYXAodG9rZW5pemVfZnVuY3Rpb24sIGJhdGNoZWQ9VHJ1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAuc2h1ZmZsZShzZWVkPTI1KQogICAgICAgICAgICAgICAgICAgICAgICAgIC5yZW1vdmVfY29sdW1ucyhbJ3RleHQnLCAndG9rZW5fdHlwZV9pZHMnXSkpCiAgICBwcmludChmJy0tTG9hZGluZyB0aGUgbW9kZWwgZm9yIHByZWRpY3Rpbmcge251bV9sYWJlbHN9IGxhYmVscy0tJykKICAgIGNvbmZpZyA9IEF1dG9Db25maWcuZnJvbV9wcmV0cmFpbmVkKG1vZGVsX25hbWUsIG51bV9sYWJlbHM9bnVtX2xhYmVscykgICNmb3IgbGF0ZXIgc2F2aW5nIHRoZSBjb25maWcKICAgIG1vZGVsID0gKEJlcnRGb3JTZW50ZW5jZUNsYXNzaWZpY2F0aW9uCiAgICAgICAgIC5mcm9tX3ByZXRyYWluZWQocHJldHJhaW5lZF9tb2RlbF9uYW1lX29yX3BhdGg9bW9kZWxfbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbF9uYW1lPW1vZGVsX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnPWNvbmZpZywKICAgICAgICAgICAgICAgICAgICAgICAgICBudW1fbGFiZWxzPW51bV9sYWJlbHMpKSAjY2xhc3Nfd2VpZ2h0cz1jbGFzc193ZWlnaHRzCiAgICB0cmFpbmluZ19hcmdzID0gVHJhaW5pbmdBcmd1bWVudHMoCiAgICAgICAgb3V0cHV0X2Rpcj1vdXRwdXRfZGlyLAogICAgICAgIGxvZ2dpbmdfZGlyPWxvZ2dpbmdfZGlyLAogICAgICAgIGV2YWxfc3RyYXRlZ3k9J2Vwb2NoJywKICAgICAgICBzYXZlX3N0cmF0ZWd5PSdlcG9jaCcsCiAgICAgICAgc2F2ZV90b3RhbF9saW1pdD0yLAogICAgICAgIG51bV90cmFpbl9lcG9jaHM9bnVtX3RyYWluX2Vwb2NocywKICAgICAgICBwZXJfZGV2aWNlX3RyYWluX2JhdGNoX3NpemU9cGVyX2RldmljZV90cmFpbl9iYXRjaF9zaXplLAogICAgICAgIHBlcl9kZXZpY2VfZXZhbF9iYXRjaF9zaXplPXBlcl9kZXZpY2VfZXZhbF9iYXRjaF9zaXplLAogICAgICAgIGdyYWRpZW50X2FjY3VtdWxhdGlvbl9zdGVwcz1ncmFkaWVudF9hY2N1bXVsYXRpb25fc3RlcHMsCiAgICAgICAgd2VpZ2h0X2RlY2F5PXdlaWdodF9kZWNheSwKICAgICAgICBsZWFybmluZ19yYXRlPWxlYXJuaW5nX3JhdGUsCiAgICAgICAgbHJfc2NoZWR1bGVyX3R5cGU9bHJfc2NoZWR1bGVyX3R5cGUsCiAgICAgICAgbG9hZF9iZXN0X21vZGVsX2F0X2VuZD1UcnVlLAogICAgICAgIGV2YWx1YXRpb25fc3RyYXRlZ3kgPSAiZXBvY2giLCAjVG8gY2FsY3VsYXRlIG1ldHJpY3MgcGVyIGVwb2NoCiAgICAgICAgbG9nZ2luZ19zdHJhdGVneT0iZXBvY2giCiAgICAgICAgCiAgICApCiAgICB0cmFpbmVyID0gVHJhaW5lcigKICAgICAgICBtb2RlbD1tb2RlbCwKICAgICAgICBhcmdzPXRyYWluaW5nX2FyZ3MsCiAgICAgICAgdHJhaW5fZGF0YXNldD10b2tlbml6ZWRfZGF0YXNldHNbJ3RyYWluJ10sCiAgICAgICAgZXZhbF9kYXRhc2V0PXRva2VuaXplZF9kYXRhc2V0c1sndmFsaWRhdGlvbiddLAogICAgICAgIGNhbGxiYWNrcz1bRWFybHlTdG9wcGluZ0NhbGxiYWNrKGVhcmx5X3N0b3BwaW5nX3BhdGllbmNlPTEpXSwKICAgICAgICBjb21wdXRlX21ldHJpY3M9Y29tcHV0ZV9tZXRyaWNzCiAgICApCiAgICB0cmFpbmVyLnRva2VuaXplciA9IHRva2VuaXplX2Z1bmN0aW9uLmdldF90b2tlbml6ZXIoKQogICAgCiAgICBoYW5kbGVyID0gVHJhaW5lckhhbmRsZXIoCiAgICAgICAgdHJhaW5lcj10cmFpbmVyLAogICAgICAgIHRva2VuaXplZF9kYXRhc2V0cz10b2tlbml6ZWRfZGF0YXNldHMsCiAgICAgICAgbnVtX2xhYmVscz1udW1fbGFiZWxzLAogICAgICAgIGVuY29kaW5nPWVuY29kaW5nLAogICAgICAgIG1vZGVsX25hbWU9dGFyZ2V0X21vZGVsX25hbWUsCiAgICAgICAgbW9kZWxfc2F2ZV9wYXRoPW1vZGVsX2RpcgogICAgKQogICAgaGFuZGxlci5ydW4oKQoKICAgIGRmID0gcGQucmVhZF9jc3YobW9kZWxfZGlyICsgJy90cmFpbl9tZXRyaWNzLmNzdicpCiAgICBsYXN0X3JvdyA9IGRmLnRhaWwoMSkKICAgIG1vZGVsX21ldHJpY3MgPSBbImYxIiwiYWNjdXJhY3kiLCAicmVjYWxsIiwgInByZWNpc2lvbiJdCiAgICBtZXRyaWNzID0ge30KICAgIGZvciBtZXQgaW4gbW9kZWxfbWV0cmljczogICAgCiAgICAgICAgbWV0cmljc1ttZXRdID0gbGFzdF9yb3dbbWV0XS52YWx1ZXNbMF0KICAgIG1kbCA9IHByb2plY3QubG9nX21vZGVsKAogICAgICAgIG5hbWU9dGFyZ2V0X21vZGVsX25hbWUsCiAgICAgICAga2luZD0iaHVnZ2luZ2ZhY2UiLAogICAgICAgIGJhc2VfbW9kZWw9ImRibWR6L2JlcnQtYmFzZS1pdGFsaWFuLXh4bC1jYXNlZCIsCiAgICAgICAgcGFyYW1ldGVycz1tb2RlbF9wYXJhbXMsCiAgICAgICAgc291cmNlPW1vZGVsX2RpciwKICAgICkgICAgICAgICAgICAKICAgIGZvciBrIGluIG1ldHJpY3M6CiAgICAgICAgbWRsLmxvZ19tZXRyaWMoaywgbWV0cmljc1trXSkKCg==
    lang: python
---
kind: "python+job"
spec: 
  template:
    inputs: {}
    parameters: 
      target_model_name: document-classifier
      num_train_epochs: 1
      per_device_train_batch_size: 16
      per_device_eval_batch_size: 16
      gradient_accumulation_steps: 2
      weight_decay: 0.005
      learning_rate: 0.00001
      lr_scheduler_type: linear
  profile: 1xa100
  volumes:
    - name: train-volume
      spec:
        size: 10Gi
      volume_type: persistent_volume_claim
      mount_path: /local-data
  envs:
    - name: HF_HOME
      value: /local-data/huggingface
    - name: TRANSFORMERS_CACHE
      value: /local-data/huggingface
  resources:
    mem: 8Gi
  fs_group: 8877